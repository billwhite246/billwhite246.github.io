<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>模拟电子钱包账户并发转账环境产生的脏数据及改进办法(java+mysql) | Bill's blog</title><meta name="description" content="模拟电子钱包账户并发转账环境产生的脏数据及改进办法(java+mysql)"><meta name="keywords" content="并发"><meta name="author" content="Bill"><meta name="copyright" content="Bill"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><meta name="twitter:card" content="summary"><meta name="twitter:title" content="模拟电子钱包账户并发转账环境产生的脏数据及改进办法(java+mysql)"><meta name="twitter:description" content="模拟电子钱包账户并发转账环境产生的脏数据及改进办法(java+mysql)"><meta name="twitter:image" content="https://img.webpro.ltd/picbed/img/20210720081536.png"><meta property="og:type" content="article"><meta property="og:title" content="模拟电子钱包账户并发转账环境产生的脏数据及改进办法(java+mysql)"><meta property="og:url" content="http://blog.webpro.ltd/2019/06/07/ewallet-concurrency-java-mysql/"><meta property="og:site_name" content="Bill's blog"><meta property="og:description" content="模拟电子钱包账户并发转账环境产生的脏数据及改进办法(java+mysql)"><meta property="og:image" content="https://img.webpro.ltd/picbed/img/20210720081536.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="/css/my/highlight/vs.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="http://blog.webpro.ltd/2019/06/07/ewallet-concurrency-java-mysql/"><link rel="prev" title="Linux c 程序设计考试 复习" href="http://blog.webpro.ltd/2019/08/09/Linux-c-review1/"><link rel="next" title="写个网站流量统计插件" href="http://blog.webpro.ltd/2019/05/29/get-my-site-pageview/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://blog.webpro.ltd/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"title":"Snackbar.bookmark.title","message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#232323","bgDark":"#2d3035","position":"top-center"},
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Bill's blog" type="application/atom+xml">
</head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Bill's blog</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-sort-amount-desc"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-calendar-o"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-university" aria-hidden="true"></i><span> AHUT</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/2020/03/12/unix-study/"><i class="fa-fw fa fa-file-pdf-o"></i><span> UNIX网络编程作业本</span></a></li><li><a class="site-page" href="/2020/03/30/dmapi/"><i class="fa-fw fa fa-file-pdf-o"></i><span> 到梦空间后台管理接口</span></a></li><li><a class="site-page" href="https://webpro.ltd/blog/static/7-20.html" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> 2019-07-13工程实践(大数据)</span></a></li><li><a class="site-page" href="/%E5%AF%BC%E5%B8%88%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0/"><i class="fa-fw fa fa-file-pdf-o"></i><span> 导师项目学习</span></a></li><li><a class="site-page" href="/sims/"><i class="fa-fw fa fa-file-pdf-o"></i><span> sims项目参数</span></a></li><li><a class="site-page" href="/2020/04/21/sims-open/"><i class="fa-fw fa fa-question-circle-o"></i><span> sims-issue</span></a></li><li><a class="site-page" href="/2021/01/19/campus-town-db/"><i class="fa-fw fa fa-file-pdf-o"></i><span> 校园小镇</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-graduation-cap" aria-hidden="true"></i><span> 2021(2)考研</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/893软件工程学科专业基础自命题科目考试大纲.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> 893考试大纲</span></a></li><li><a class="site-page" href="/2020/08/13/study-datastructure-linux-c/"><i class="fa-fw fa fa-book"></i><span> 数据结构(C++版)</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-folder" aria-hidden="true"></i><span> Books</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="https://www.webpro.ltd/blog/static/arduino-esp8266-latest/" target="_blank" rel="noopener"><i class="fa-fw fa fa-book"></i><span> ESP8266核心文档</span></a></li><li><a class="site-page" href="/2019/09/29/study-datastructure/"><i class="fa-fw fa fa-book"></i><span> 数据结构复习</span></a></li><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/Android开发规范.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> Android开发规范</span></a></li><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/java开发规范.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> java开发规范</span></a></li><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/renren-fast开发文档2.0_完整版.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> renren-fast_2.0文档</span></a></li><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/RLbook2018trimmed.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> RLbook2018trimmed</span></a></li><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/Reinforcement Learning.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> Reinforcement Learning</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-book" aria-hidden="true"></i><span> 文章</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 文章归档</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://img.webpro.ltd/picbed/img/my_avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">26</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">29</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">13</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-sort-amount-desc"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-calendar-o"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-university" aria-hidden="true"></i><span> AHUT</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/2020/03/12/unix-study/"><i class="fa-fw fa fa-file-pdf-o"></i><span> UNIX网络编程作业本</span></a></li><li><a class="site-page" href="/2020/03/30/dmapi/"><i class="fa-fw fa fa-file-pdf-o"></i><span> 到梦空间后台管理接口</span></a></li><li><a class="site-page" href="https://webpro.ltd/blog/static/7-20.html" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> 2019-07-13工程实践(大数据)</span></a></li><li><a class="site-page" href="/%E5%AF%BC%E5%B8%88%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0/"><i class="fa-fw fa fa-file-pdf-o"></i><span> 导师项目学习</span></a></li><li><a class="site-page" href="/sims/"><i class="fa-fw fa fa-file-pdf-o"></i><span> sims项目参数</span></a></li><li><a class="site-page" href="/2020/04/21/sims-open/"><i class="fa-fw fa fa-question-circle-o"></i><span> sims-issue</span></a></li><li><a class="site-page" href="/2021/01/19/campus-town-db/"><i class="fa-fw fa fa-file-pdf-o"></i><span> 校园小镇</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-graduation-cap" aria-hidden="true"></i><span> 2021(2)考研</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/893软件工程学科专业基础自命题科目考试大纲.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> 893考试大纲</span></a></li><li><a class="site-page" href="/2020/08/13/study-datastructure-linux-c/"><i class="fa-fw fa fa-book"></i><span> 数据结构(C++版)</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-folder" aria-hidden="true"></i><span> Books</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="https://www.webpro.ltd/blog/static/arduino-esp8266-latest/" target="_blank" rel="noopener"><i class="fa-fw fa fa-book"></i><span> ESP8266核心文档</span></a></li><li><a class="site-page" href="/2019/09/29/study-datastructure/"><i class="fa-fw fa fa-book"></i><span> 数据结构复习</span></a></li><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/Android开发规范.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> Android开发规范</span></a></li><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/java开发规范.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> java开发规范</span></a></li><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/renren-fast开发文档2.0_完整版.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> renren-fast_2.0文档</span></a></li><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/RLbook2018trimmed.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> RLbook2018trimmed</span></a></li><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/Reinforcement Learning.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> Reinforcement Learning</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-book" aria-hidden="true"></i><span> 文章</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 文章归档</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#场景简述"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">场景简述</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#实验环境搭建"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">实验环境搭建</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#建立-maven-项目"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">建立 maven 项目</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#建立实验数据表，E-R-图如下"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">建立实验数据表，E-R 图如下</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#建立数据表实体类-account"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">建立数据表实体类 account</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#建立数据库操作层"><span class="toc_mobile_items-number">2.4.</span> <span class="toc_mobile_items-text">建立数据库操作层</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#创建模拟数据"><span class="toc_mobile_items-number">2.5.</span> <span class="toc_mobile_items-text">创建模拟数据</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#模拟单线程消费操作-BankDemo0"><span class="toc_mobile_items-number">2.6.</span> <span class="toc_mobile_items-text">模拟单线程消费操作 BankDemo0</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#模拟多线程并发消费操作-BankDemo1"><span class="toc_mobile_items-number">2.7.</span> <span class="toc_mobile_items-text">模拟多线程并发消费操作 BankDemo1</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#算法改进"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">算法改进</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#相关知识点："><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">相关知识点：</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Ⅰ、乐观锁改进-类-CAS-无锁操作机制改进办法"><span class="toc_mobile_items-number">3.2.</span> <span class="toc_mobile_items-text">Ⅰ、乐观锁改进 - 类 CAS 无锁操作机制改进办法</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1、JVM-CAS-简述"><span class="toc_mobile_items-number">3.2.1.</span> <span class="toc_mobile_items-text">1、JVM-CAS 简述</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#2、并行转串行处理"><span class="toc_mobile_items-number">3.2.2.</span> <span class="toc_mobile_items-text">2、并行转串行处理</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#3、应用上述算法处理并发转账引起的脏数据"><span class="toc_mobile_items-number">3.2.3.</span> <span class="toc_mobile_items-text">3、应用上述算法处理并发转账引起的脏数据</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#程序分析"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">程序分析</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#场景简述"><span class="toc-number">1.</span> <span class="toc-text">场景简述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实验环境搭建"><span class="toc-number">2.</span> <span class="toc-text">实验环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#建立-maven-项目"><span class="toc-number">2.1.</span> <span class="toc-text">建立 maven 项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建立实验数据表，E-R-图如下"><span class="toc-number">2.2.</span> <span class="toc-text">建立实验数据表，E-R 图如下</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建立数据表实体类-account"><span class="toc-number">2.3.</span> <span class="toc-text">建立数据表实体类 account</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建立数据库操作层"><span class="toc-number">2.4.</span> <span class="toc-text">建立数据库操作层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建模拟数据"><span class="toc-number">2.5.</span> <span class="toc-text">创建模拟数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模拟单线程消费操作-BankDemo0"><span class="toc-number">2.6.</span> <span class="toc-text">模拟单线程消费操作 BankDemo0</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模拟多线程并发消费操作-BankDemo1"><span class="toc-number">2.7.</span> <span class="toc-text">模拟多线程并发消费操作 BankDemo1</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#算法改进"><span class="toc-number">3.</span> <span class="toc-text">算法改进</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#相关知识点："><span class="toc-number">3.1.</span> <span class="toc-text">相关知识点：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ⅰ、乐观锁改进-类-CAS-无锁操作机制改进办法"><span class="toc-number">3.2.</span> <span class="toc-text">Ⅰ、乐观锁改进 - 类 CAS 无锁操作机制改进办法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、JVM-CAS-简述"><span class="toc-number">3.2.1.</span> <span class="toc-text">1、JVM-CAS 简述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、并行转串行处理"><span class="toc-number">3.2.2.</span> <span class="toc-text">2、并行转串行处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、应用上述算法处理并发转账引起的脏数据"><span class="toc-number">3.2.3.</span> <span class="toc-text">3、应用上述算法处理并发转账引起的脏数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#程序分析"><span class="toc-number">4.</span> <span class="toc-text">程序分析</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://img.webpro.ltd/picbed/img/20210720081536.png)"><div id="post-info"><div id="post-title"><div class="posttitle">模拟电子钱包账户并发转账环境产生的脏数据及改进办法(java+mysql)</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2019-06-07<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2021-07-20</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%B9%B6%E5%8F%91/">并发</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="场景简述"><a href="#场景简述" class="headerlink" title="场景简述"></a>场景简述</h1><p>假设用户 A 线上消费，其账户内有余额 100 元，现在他给 B 商户付款 99 元，写成最简单的业务逻辑大概是这样的：</p>
<ul>
<li><ol>
<li>数据库查询(SELECT)A 账户余额(100)</li>
</ol>
</li>
<li><ol start="2">
<li>判断 A 账户余额是否够支付抵扣(100 - 99 &gt;= 0)</li>
</ol>
</li>
<li><ol start="3">
<li>如果够抵扣，数据库执行扣款操作(UPDATE)，商户 B 加款(A-&gt;Banance -= 99, B-&gt;Banance += 99)；如果不够抵扣，不执行操作</li>
</ol>
</li>
</ul>
<p>这是一个典型的单线程消费模式，显然如果每次都执行这一个操作，这个算法是正确无误的，下面进行一个稍微复杂的操作，假设 A 线上消费，A 转账，其账户内有余额 100 元，现在他给 B 商户付款 100 元，给商户 C 转账 100 元，且线上消费和转账是同时进行的，那么会产生多种可能，把所有的操作步骤拆分成以下 6 个步骤:</p>
<p>===</p>
<p>$1 表示账户余额</p>
<p>$2 表示消费金额</p>
<p>===</p>
<ul>
<li><ol>
<li>A11 数据库查询(SELECT)A 账户余额($1) =&gt; trans for B</li>
</ol>
</li>
<li><ol start="2">
<li>A12 判断 A 账户余额是否够支付抵扣($1- $2 &gt;= 0) =&gt; trans for B</li>
</ol>
</li>
<li><ol start="3">
<li>A13 如果够抵扣，数据库执行扣款操作(UPDATE)，商户 B 加款(A-&gt;Banance -= $2, B-&gt;Banance += $2) =&gt; trans for B；如果不够抵扣，不执行操作，提示余额不足 =&gt; trans for B</li>
</ol>
</li>
<li><ol start="4">
<li>A21 数据库查询(SELECT)A 账户余额($1) =&gt; trans for C</li>
</ol>
</li>
<li><ol start="5">
<li>A22 判断 A 账户余额是否够支付抵扣($1- $2 &gt;= 0) =&gt; trans for C</li>
</ol>
</li>
<li><ol start="6">
<li>A23 如果够抵扣，数据库执行扣款操作(UPDATE)，商户 C 加款(A-&gt;Banance -= $2, B-&gt;Banance += $2) =&gt; trans for C；如果不够抵扣，不执行操作，提示余额不足 =&gt; trans for C</li>
</ol>
</li>
</ul>
<blockquote>
<p>执行情况 1（序号相同的表示近乎同一时刻执行，序号越大执行顺序越偏后，单个线程的执行方式为同步执行）:</p>
</blockquote>
<p>Thread1: A11(0)-&gt;A12(1)-&gt;A13(2)</p>
<p>Thread2: A21(3)-&gt;A22(4)-&gt;A23(5)</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720073513.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720073513.png" class="lazyload" title></a></p>
<blockquote>
<p>执行情况 2（序号相同的表示近乎同一时刻执行，序号越大执行顺序越偏后，单个线程的执行方式为同步执行）:</p>
</blockquote>
<p>Thread1: A11(0)-&gt;A12(1)-&gt;A13(2)</p>
<p>Thread2: A21(0)-&gt;A22(1)-&gt;A23(2)</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720073534.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720073534.png" class="lazyload" title></a></p>
<p>这里仅仅列举两种很特殊的情况作为例子说明，执行情况要远远复杂于上述两种情况</p>
<p>对于执行情况 1，向商户 B 支付扣款成功，而给 C 转账时，系统会提示余额不足</p>
<p>对于执行情况 2，向商户 B 支付扣款成功，给 C 转账扣款会仍然成功</p>
<blockquote>
<p>执行结果的不同主要在于 A13 步骤的 UPDATE 事务提交操作，如果在 A13 的 UPDATE 成功之前执行 A21，那么 A21 查询出来的账户余额仍然是 100，依然可以进行消费，而事实却是此时正在进行的 A11 消费还没扣款成功，这样便使得一份余额重复使用，也就是产生了脏数据。而情况 1 是一个非常理想的情况，实际执行过程中个几乎不会发生 A13 执行完毕后，才会执行 A21，因为数据库的 SELECT 操作速度要快于 UPDATE 操作，因此很大可能是 A13 执行 UPDATE 之前，A11 和 A21 就已经完成了数据的查询，从而重复使用同一份余额。当然上面讲的 2 种情况是 2 个极端情况下的理想情况，实际情况更复杂更微妙。实际情况下，这样执行通常会会产生脏数据。</p>
</blockquote>
<h1 id="实验环境搭建"><a href="#实验环境搭建" class="headerlink" title="实验环境搭建"></a>实验环境搭建</h1><p>我们首先搭建一个上述提到的消费场景环境，模拟其产生脏数据的过程。这里用 java+mysql 来实现，采用 maven 项目构建。</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>参数值</th>
</tr>
</thead>
<tbody><tr>
<td>数据库地址</td>
<td>127.0.0.1</td>
</tr>
<tr>
<td>帐户</td>
<td>root</td>
</tr>
<tr>
<td>密码</td>
<td>root</td>
</tr>
<tr>
<td>端口</td>
<td>3306</td>
</tr>
<tr>
<td>字符编码</td>
<td>UTF-8</td>
</tr>
<tr>
<td>数据库名</td>
<td>studyjpa</td>
</tr>
<tr>
<td>数据表名</td>
<td>bank_account</td>
</tr>
</tbody></table>
<p>【自己搭建环境修改响应参数】</p>
<h2 id="建立-maven-项目"><a href="#建立-maven-项目" class="headerlink" title="建立 maven 项目"></a>建立 maven 项目</h2><ul>
<li>引入 jdbc 依赖，修改默认 jdk 编译版本为 jdk1.8</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">xml</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight xml"><figcaption><span>application.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.25<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure></div>

<h2 id="建立实验数据表，E-R-图如下"><a href="#建立实验数据表，E-R-图如下" class="headerlink" title="建立实验数据表，E-R 图如下"></a>建立实验数据表，E-R 图如下</h2><p><a href="https://img.webpro.ltd/picbed/img/20210720073959.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720073959.png" class="lazyload" title></a></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`bank_account`</span> (<br>  <span class="hljs-string">`id`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> AUTO_INCREMENT <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'客户编号'</span>,<br>  <span class="hljs-string">`balance`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'账户余额-分为单位'</span>,<br>  <span class="hljs-string">`card_number`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,<br>  <span class="hljs-string">`customer`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,<br>  PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`id`</span>)<br>) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span> AUTO_INCREMENT=<span class="hljs-number">5</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8;<br></code></pre></td></tr></table></figure></div>

<ul>
<li>用 InnoDB 引擎</li>
</ul>
<h2 id="建立数据表实体类-account"><a href="#建立数据表实体类-account" class="headerlink" title="建立数据表实体类 account"></a>建立数据表实体类 account</h2><p>工程目录结构如下:</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720074039.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720074039.png" class="lazyload" title></a></p>
<p>两个包:</p>
<ul>
<li>package Bank</li>
<li>package Bank.dbBean</li>
</ul>
<p>在 Bank.dbBean 下建立 bank_account 表的实体类</p>
<p>printInfo 方法可输出一个 account 对象内存储的数据</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><figcaption><span>account.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Bank.dbBean;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">account</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> balance;<br>    <span class="hljs-keyword">private</span> String card_number;<br>    <span class="hljs-keyword">private</span> String customer;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">account</span><span class="hljs-params">()</span></span>&#123;<br>        id = -<span class="hljs-number">1</span>;<br>        balance = <span class="hljs-number">0</span>;<br>        card_number = <span class="hljs-string">""</span>;<br>        customer = <span class="hljs-string">""</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">printInfo</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">"[ id =&gt; "</span> + id + <span class="hljs-string">" , balance =&gt; "</span> + balance + <span class="hljs-string">" , card_number =&gt; "</span> + card_number + <span class="hljs-string">" , customer =&gt; "</span> + customer + <span class="hljs-string">" ]"</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getBalance</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> balance;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBalance</span><span class="hljs-params">(<span class="hljs-keyword">int</span> balance)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.balance = balance;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getCard_number</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> card_number;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCard_number</span><span class="hljs-params">(String card_number)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.card_number = card_number;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getCustomer</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> customer;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCustomer</span><span class="hljs-params">(String customer)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.customer = customer;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></div>

<h2 id="建立数据库操作层"><a href="#建立数据库操作层" class="headerlink" title="建立数据库操作层"></a>建立数据库操作层</h2><p>包括以下两个方法：</p>
<ul>
<li><ol>
<li>通过卡号查询对应客户所有信息</li>
</ol>
<ul>
<li>通过卡号查询信息</li>
<li>@param String cardNumber</li>
<li>@return account account</li>
</ul>
</li>
<li><ol start="2">
<li>转账操作</li>
</ol>
<ul>
<li>@param String senderCardNumber</li>
<li>@param String receiverCardNumber</li>
<li>@param int transCount</li>
<li>转账之前，转账完成后，都输出 sender 和 receiver 的账户信息，以供比对</li>
<li>void 异步执行</li>
<li>提交 UPDATE 事务时单开了个线程，提高效率</li>
</ul>
</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><figcaption><span>Bean.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Bank;<br><br><span class="hljs-keyword">import</span> Bank.dbBean.account;<br><br><span class="hljs-keyword">import</span> java.sql.*;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 简易Bean</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bean</span> </span>&#123;<br><br>    <span class="hljs-comment">// 参数配置</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String dbName    =   <span class="hljs-string">"studyjpa"</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL       =   <span class="hljs-string">"jdbc:mysql://127.0.0.1:3306/"</span> + dbName + <span class="hljs-string">"?useUnicode=true&amp;characterEncoding=UTF-8"</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String user      =   <span class="hljs-string">"root"</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String password  =   <span class="hljs-string">"root"</span>;<br>    <span class="hljs-comment">// 数据库句柄</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection conn;<br>    <span class="hljs-comment">// SQL模板</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> PreparedStatement sql;<br>    <span class="hljs-comment">// res</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ResultSet res;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自动连接数据库</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Bean</span><span class="hljs-params">()</span></span>&#123;<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            Class.forName(<span class="hljs-string">"com.mysql.jdbc.Driver"</span>); <span class="hljs-comment">// 加载驱动</span><br>        &#125;<span class="hljs-keyword">catch</span>(ClassNotFoundException e) &#123;<br>            <span class="hljs-comment">// 捕捉到错误</span><br>            System.out.println(<span class="hljs-string">"ClassNotFoundException!"</span> + e);<br>        &#125;<br><br>        <span class="hljs-comment">// 连接至数据库</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            conn = DriverManager.getConnection(URL, user, password);<br>            conn.setAutoCommit(<span class="hljs-keyword">false</span>);<br>            System.out.println(dbName + <span class="hljs-string">" opened SUCCESS"</span>);<br>        &#125;<span class="hljs-keyword">catch</span>(SQLException e) &#123;<br>            <span class="hljs-comment">// 捕捉到错误</span><br>            System.out.println(dbName + <span class="hljs-string">" opened error!"</span> + e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过卡号查询信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> String cardNumber</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> account account</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> account <span class="hljs-title">findByCardNumber</span><span class="hljs-params">(String cardNumber)</span></span>&#123;<br>        account r = <span class="hljs-keyword">new</span> account();<br>        <span class="hljs-keyword">try</span>&#123;<br><span class="hljs-comment">//            System.out.println("conn.isClosed=" + conn.isClosed());</span><br>            <span class="hljs-comment">// 构造SQL模板</span><br>            sql = conn.prepareStatement(<span class="hljs-string">"SELECT  `id`, `balance`, `card_number`, `customer` FROM `bank_account` WHERE `card_number`=?"</span>);<br>            <span class="hljs-comment">// 填充模板</span><br>            sql.setString(<span class="hljs-number">1</span>, cardNumber);<br>            <span class="hljs-comment">// 执行SQL语句</span><br>            res = sql.executeQuery();<br>            <span class="hljs-keyword">if</span>(res.next())&#123;<br>                r.setId(res.getInt(<span class="hljs-string">"id"</span>));<br>                r.setBalance(res.getInt(<span class="hljs-string">"balance"</span>));<br>                r.setCard_number(res.getString(<span class="hljs-string">"card_number"</span>));<br>                r.setCustomer(res.getString(<span class="hljs-string">"customer"</span>));<br>            &#125;<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>            <span class="hljs-comment">// 捕捉到错误</span><br>            System.out.println(<span class="hljs-string">"Exception! FROM SELECT : "</span> + e + <span class="hljs-string">" card_number: "</span> + cardNumber);<br><br>        &#125;<br>        <span class="hljs-keyword">return</span> r;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 转账操作</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> String senderCardNumber</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> String receiverCardNumber</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> int transCount</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> List&lt;account&gt; - del</span><br><span class="hljs-comment">     *     index0=&gt;senderBeforeSend, index1=&gt;receiverBeforeReceive - del</span><br><span class="hljs-comment">     *     index2=&gt;senderAfterSend, index3=&gt;receiverAfterReceive - del</span><br><span class="hljs-comment">     * void type 异步执行</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">transMoney</span><span class="hljs-params">(String senderCardNumber, String receiverCardNumber, <span class="hljs-keyword">int</span> transCount)</span></span>&#123;<br>        <span class="hljs-comment">// 初始化</span><br>        account sender0 = findByCardNumber(senderCardNumber);<br>        account receiver0 = findByCardNumber(receiverCardNumber);<br>        List&lt;account&gt; r = <span class="hljs-keyword">new</span> ArrayList&lt;account&gt;()&#123;<br>            &#123;<br>                add(sender0);<br>                add(receiver0);<br>                add(sender0);<br>                add(receiver0);<br>            &#125;<br>        &#125;;<br>        <span class="hljs-comment">// 执行转账</span><br>        <span class="hljs-keyword">int</span> senderBalance = sender0.getBalance();<br>        <span class="hljs-keyword">int</span> receiverBalance = receiver0.getBalance();<br>        <span class="hljs-comment">// sender 账户余额是否充足</span><br>        <span class="hljs-keyword">if</span>(senderBalance - transCount &gt;= <span class="hljs-number">0</span>)&#123;<br>            senderBalance -= transCount;<br>            receiverBalance += transCount;<br>            <span class="hljs-keyword">try</span>&#123;<br>                <span class="hljs-comment">// 构造SQL模板</span><br>                sql = conn.prepareStatement(<span class="hljs-string">"UPDATE `bank_account` SET `balance`=? WHERE `card_number`=?"</span>);<br>                <span class="hljs-comment">// 填充模板</span><br>                sql.setInt(<span class="hljs-number">1</span>, senderBalance);<br>                sql.setString(<span class="hljs-number">2</span>, senderCardNumber);<br>                sql.executeUpdate();<br><br>                <span class="hljs-comment">// 填充模板</span><br>                sql.setInt(<span class="hljs-number">1</span>, receiverBalance);<br>                sql.setString(<span class="hljs-number">2</span>, receiverCardNumber);<br>                sql.executeUpdate();<br><br>                <span class="hljs-comment">// 开个新线程处理</span><br>                <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>                    <span class="hljs-comment">// 这里不出错就不会再出错了</span><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        conn.commit();<br>                        List&lt;account&gt; r1 = <span class="hljs-keyword">new</span> ArrayList&lt;account&gt;()&#123;<br>                            &#123;<br>                                add(sender0);<br>                                add(receiver0);<br>                                add(findByCardNumber(senderCardNumber));<br>                                add(findByCardNumber(receiverCardNumber));<br>                            &#125;<br>                        &#125;;<br>                        <span class="hljs-keyword">for</span> (account item : r1) &#123;<br>                            item.printInfo();<br>                        &#125;<br>                    &#125;<span class="hljs-keyword">catch</span>(SQLException e) &#123;<br>                        <span class="hljs-comment">// 捕捉到错误</span><br>                        <span class="hljs-keyword">try</span>&#123;<br>                            conn.rollback();<br>                            System.out.println(<span class="hljs-string">"new Thread update fail - been rollback!"</span> + e);<br>                        &#125;<span class="hljs-keyword">catch</span>(SQLException e1)&#123;<br>                            System.out.println(<span class="hljs-string">"rollback fail!"</span> + e1);<br>                        &#125;<br>                        System.out.println(<span class="hljs-string">"new Thread update fail! "</span> + e);<br>                    &#125;<br>                &#125;).start();<br>            &#125;<span class="hljs-keyword">catch</span>(SQLException e) &#123;<br>                <span class="hljs-comment">// 捕捉到错误</span><br>                <span class="hljs-keyword">try</span>&#123;<br>                    conn.rollback();<br>                    System.out.println(<span class="hljs-string">"been rollback!"</span> + e);<br>                &#125;<span class="hljs-keyword">catch</span>(SQLException e1)&#123;<br>                    System.out.println(<span class="hljs-string">"rollback fail!"</span> + e1);<br>                &#125;<br>                System.out.println(<span class="hljs-string">"SQLException!"</span> + e);<br>                <span class="hljs-keyword">for</span> (account item : r) &#123;<br>                    item.printInfo();<br>                &#125;<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            System.out.println(<span class="hljs-string">"senderCardNumber: "</span> + senderCardNumber + <span class="hljs-string">", Balance cannot afford, transCount: "</span> + transCount);<br>            <span class="hljs-keyword">for</span> (account item : r) &#123;<br>                item.printInfo();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></div>

<h2 id="创建模拟数据"><a href="#创建模拟数据" class="headerlink" title="创建模拟数据"></a>创建模拟数据</h2><blockquote>
<p>向 bank_account 表中插入 4 条记录</p>
</blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- Records of bank_account</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">`bank_account`</span> <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-number">200</span>, <span class="hljs-string">'1000'</span>, <span class="hljs-string">'ZhangSan'</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">`bank_account`</span> <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'1001'</span>, <span class="hljs-string">'LiSi'</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">`bank_account`</span> <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'1002'</span>, <span class="hljs-string">'WangWu'</span>);<br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">`bank_account`</span> <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'1003'</span>, <span class="hljs-string">'ZhaoLiu'</span>);<br></code></pre></td></tr></table></figure></div>

<table>
<thead>
<tr>
<th>余额</th>
<th>卡号</th>
<th>客户姓名</th>
</tr>
</thead>
<tbody><tr>
<td>200</td>
<td>1000</td>
<td>张三</td>
</tr>
<tr>
<td>0</td>
<td>1001</td>
<td>李四</td>
</tr>
<tr>
<td>0</td>
<td>1002</td>
<td>王五</td>
</tr>
<tr>
<td>0</td>
<td>1003</td>
<td>赵六</td>
</tr>
</tbody></table>
<h2 id="模拟单线程消费操作-BankDemo0"><a href="#模拟单线程消费操作-BankDemo0" class="headerlink" title="模拟单线程消费操作 BankDemo0"></a>模拟单线程消费操作 BankDemo0</h2><p>该步骤用来检验上述写的基本业务逻辑是否正常、运算正确</p>
<p>在 BankDemo0 类中创建启动入口函数，同步执行转账操作</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><figcaption><span>BankDemo0.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Bank;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BankDemo0</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;<br><br>        Bean bean = <span class="hljs-keyword">new</span> Bean();<br>        String sender = <span class="hljs-string">"1000"</span>;<br>        String Lisi = <span class="hljs-string">"1001"</span>;<br>        String WangWu = <span class="hljs-string">"1002"</span>;<br>        String ZhaoLiu = <span class="hljs-string">"1003"</span>;<br>        String[] acc = <span class="hljs-keyword">new</span> String[<span class="hljs-number">3</span>];<br>        acc[<span class="hljs-number">0</span>] = Lisi;<br>        acc[<span class="hljs-number">1</span>] = WangWu;<br>        acc[<span class="hljs-number">2</span>] = ZhaoLiu;<br>        <span class="hljs-keyword">int</span> i;<br>        <span class="hljs-keyword">int</span> transCount = <span class="hljs-number">100</span>;<br>        <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;<br>            bean.transMoney(sender, acc[i], transCount);<br>        &#125;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></div>

<p>该方法模拟了张三（sender，卡号 1000）分别（非并发）向李四、王五、赵六三人转账 100 分(1 元=100 分，数据库中以分为单位计数)的操作。</p>
<p>我们执行一下，查看结果:</p>
<p>运行前，数据表展示：</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720074709.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720074709.png" class="lazyload" title></a></p>
<p>运行后，调试台输出：</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720074730.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720074730.png" class="lazyload" title></a></p>
<pre>
studyjpa opened SUCCESS
[ id => 1 , balance => 200 , card_number => 1000 , customer => ZhangSan ]
[ id => 2 , balance => 0 , card_number => 1001 , customer => LiSi ]
[ id => 1 , balance => 100 , card_number => 1000 , customer => ZhangSan ]
[ id => 2 , balance => 100 , card_number => 1001 , customer => LiSi ]
senderCardNumber: 1000, Balance cannot afford, transCount: 100
[ id => 1 , balance => 0 , card_number => 1000 , customer => ZhangSan ]
[ id => 4 , balance => 0 , card_number => 1003 , customer => ZhaoLiu ]
[ id => 1 , balance => 100 , card_number => 1000 , customer => ZhangSan ]
[ id => 1 , balance => 0 , card_number => 1000 , customer => ZhangSan ]
[ id => 4 , balance => 0 , card_number => 1003 , customer => ZhaoLiu ]
[ id => 3 , balance => 0 , card_number => 1000 , customer => ZhangSan ]
[ id => 1 , balance => 0 , card_number => 1000 , customer => ZhangSan ]
[ id => 3 , balance => 100 , card_number => 1003 , customer => ZhaoLiu ]
Process finished with exit code 0
</pre>

<p>数据表展示：</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720075155.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720075155.png" class="lazyload" title></a></p>
<p>业务逻辑执行的非常正确，按照李四、王五、赵六的先后顺序转账，在对赵六进行转账时系统提示余额不足：</p>
<p>senderCardNumber: 1000, Balance cannot afford, transCount: 100</p>
<h2 id="模拟多线程并发消费操作-BankDemo1"><a href="#模拟多线程并发消费操作-BankDemo1" class="headerlink" title="模拟多线程并发消费操作 BankDemo1"></a>模拟多线程并发消费操作 BankDemo1</h2><p>在 BankDemo1 类中创建启动入口函数，新建线程池，执行并发</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><figcaption><span>BankDemo1.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Bank;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BankDemo1</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>&#123;<br><br>        ExecutorService executor1 = Executors.newCachedThreadPool();<br>        Bean bean = <span class="hljs-keyword">new</span> Bean();<br>        String sender = <span class="hljs-string">"1000"</span>;<br>        String Lisi = <span class="hljs-string">"1001"</span>;<br>        String WangWu = <span class="hljs-string">"1002"</span>;<br>        String ZhaoLiu = <span class="hljs-string">"1003"</span>;<br>        String[] acc = <span class="hljs-keyword">new</span> String[<span class="hljs-number">3</span>];<br>        acc[<span class="hljs-number">0</span>] = Lisi;<br>        acc[<span class="hljs-number">1</span>] = WangWu;<br>        acc[<span class="hljs-number">2</span>] = ZhaoLiu;<br>        <span class="hljs-keyword">int</span> i;<br>        <span class="hljs-keyword">int</span> transCount = <span class="hljs-number">100</span>;<br>        <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)&#123;<br>            String temp = acc[i];<br>            executor1.submit(() -&gt; &#123;<br>                    <span class="hljs-keyword">try</span>&#123;<br>                        bean.transMoney(sender, temp, transCount);<br>                    &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>                        e.printStackTrace();<br>                    &#125;<br>                &#125;<br>            );<br>        &#125;<br>        executor1.shutdownNow();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></div>

<p>该方法模拟了张三（sender，卡号 1000）同时（并发）向李四、王五、赵六三人转账 100 分(1 元=100 分，数据库中以分为单位计数)的操作。</p>
<p>（李四、王五、赵六账户余额均为 0 元）</p>
<p>我们执行一下，查看结果:</p>
<p>运行前：</p>
<p>数据表展示：</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720075300.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720075300.png" class="lazyload" title></a></p>
<p>运行后：</p>
<p>调试台输出：</p>
<pre>
studyjpa opened SUCCESS
Exception! FROM SELECT : java.lang.NullPointerException card_number: 1000
Exception! FROM SELECT : java.sql.SQLException: Before start of result set card_number: 1000
[ id => 1 , balance => 200 , card_number => 1000 , customer => WangWu ]
[ id => 1 , balance => 200 , card_number =>  , customer =>  ]
[ id => 3 , balance => 0 , card_number => 1002 , customer => WangWu ]
[ id => 1 , balance => 100 , card_number => 1000 , customer => ZhangSan ]
[ id => 3 , balance => 0 , card_number => 1003 , customer => ZhaoLiu ]
[ id => 1 , balance => 200 , card_number => 1000 , customer => WangWu ]
[ id => 4 , balance => 0 , card_number => 1003 , customer => ZhaoLiu ]
[ id => 2 , balance => 0 , card_number => 1003 , customer => ZhaoLiu ]
[ id => 1 , balance => 0 , card_number =>  , customer =>  ]
[ id => 2 , balance => 100 , card_number => 1003 , customer => ZhaoLiu ]
[ id => 1 , balance => 100 , card_number => 1000 , customer => ZhangSan ]
[ id => 4 , balance => 0 , card_number => 1003 , customer => ZhaoLiu ]
Process finished with exit code 0
</pre>

<p>数据表展示：</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720075351.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720075351.png" class="lazyload" title></a></p>
<p>成功获取脏数据，显然凭空多出了 100 分，实验开始时总资产为 200，而并发执行后，总资产变为 300，可见在并发消费下，出现了逻辑错误。</p>
<p>重置表中的数据，反复运行几次，直接查看表数据变化：</p>
<p>===</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720075407.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720075407.png" class="lazyload" title></a></p>
<p>===</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720075419.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720075419.png" class="lazyload" title></a></p>
<p>===</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720075431.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720075431.png" class="lazyload" title></a></p>
<p>===</p>
<p>… …</p>
<p>执行结果具有不确定性，这也反映了线程在执行时 CPU 对任务的快速切换选择顺序也是不确定的。</p>
<h1 id="算法改进"><a href="#算法改进" class="headerlink" title="算法改进"></a>算法改进</h1><p>我们的常规业务逻辑在单线程模式下运行正常，然而在多线程模式下却发生了错误，所以我们需要改进算法，支持多线程并发模式消费。</p>
<p>上述并发产生错误的原因，是由于在 UPDATE 没有操作成功时（包括 UPDATE 操作之前/操作中（并没有操作完成））我们便进行了第二次的查询操作，余额重复使用产生了脏数据。纠其根本原因，还是在于 MySQL 数据库对于多线程处理默认使用乐观锁，所以 update 的时候并不会完全锁死表，仍然支持查询，在此时很大可能就在查询数据，查询到的仍然是旧的数据，所以从根本上导致了数据错乱，最终导致脏数据的产生。</p>
<p>===</p>
<h2 id="相关知识点："><a href="#相关知识点：" class="headerlink" title="相关知识点："></a>相关知识点：</h2><blockquote>
<p>事务的四个特性：原子性，一致性，隔离性，持久性</p>
</blockquote>
<ul>
<li><p>原子性：包含在事务内的所有操作，要么全部执行完成，要么全部执行失败</p>
</li>
<li><p>一致性：包含在事务内的所有操作设计的数据行，能被查看到的要么全部执行完成后的结果，要么全部完成前的结果。也就是说小明有 100 块，小花有 10 块，小明给小花转了 50 块。那么对于其他事务来说，能看到的只有是小明有 50 块同时小花有 60 块。或者是小明有 100 块同时小花有 10 块。而不能出现小明有 50 块而小花有 10 块。这就叫做一致性</p>
</li>
<li><p>持久性：事务执行完成后数据被持久化到磁盘。</p>
</li>
<li><p>隔离性：隔离性有四大隔离级别：</p>
<ul>
<li>① Serializable (串行化)：可避免脏读、不可重复读、幻读的发生。</li>
<li>② Repeatable read (可重复读)：可避免脏读、不可重复读的发生。</li>
<li>③ Read committed (读已提交)：可避免脏读的发生。</li>
<li>④ Read uncommitted (读未提交)：最低级别，任何情况都无法保证。</li>
</ul>
</li>
</ul>
<blockquote>
<p>脏读，幻读</p>
</blockquote>
<ul>
<li>a、脏读</li>
</ul>
<p>脏读是指在一个事务处理过程里读取了另一个未提交的事务中的数据。</p>
<p>当一个事务正在多次修改某个数据，而在这个事务中这多次的修改都还未提交，这时一个并发的事务来访问该数据，就会造成两个事务得到的数据不一致。</p>
<ul>
<li>b、不可重复读</li>
</ul>
<p>不可重复读是指在对于数据库中的某个数据，一个事务范围内多次查询却返回了不同的数据值，这是由于在查询间隔，被另一个事务修改并提交了。</p>
<ul>
<li>c、虚读(幻读)</li>
</ul>
<p>幻读是事务非独立执行时发生的一种现象。例如事务 T1 对一个表中所有的行的某个数据项做了从“1”修改为“2”的操作，这时事务 T2 又对这个表中插入了一行数据项，而这个数据项的数值还是为“1”并且提交给数据库。而操作事务 T1 的用户如果再查看刚刚修改的数据，会发现还有一行没有修改，其实这行是从事务 T2 中添加的，就好像产生幻觉一样，这就是发生了幻读。</p>
<p>幻读和不可重复读都是读取了另一条已经提交的事务（这点就脏读不同），所不同的是不可重复读查询的都是同一个数据项，而幻读针对的是一批数据整体（比如数据的个数）。</p>
<p>===</p>
<h2 id="Ⅰ、乐观锁改进-类-CAS-无锁操作机制改进办法"><a href="#Ⅰ、乐观锁改进-类-CAS-无锁操作机制改进办法" class="headerlink" title="Ⅰ、乐观锁改进 - 类 CAS 无锁操作机制改进办法"></a>Ⅰ、乐观锁改进 - 类 CAS 无锁操作机制改进办法</h2><h3 id="1、JVM-CAS-简述"><a href="#1、JVM-CAS-简述" class="headerlink" title="1、JVM-CAS 简述"></a>1、JVM-CAS 简述</h3><p>JVM 为了保证数据不被脏读，措施之一就是采用了 CAS（compare and set）操作机制。我们举个简单的例子了解一下该机制：</p>
<p>对于某个变量 A，我们为其增加一个版本号 version，使用 getA(version)方法获取 A 的值，使用 setA(value1, version++)来更新 A 的值，即每次更新 A 的值其版本号都+1。现在有 2 个线程，Thread1 and Thread2，Thread1=&gt;( getA( 0 ), setA( v2, 0 ) ), Thread2=&gt;( getA( 0 ), setA(v3, 0) )。CPU 必定会先调取某一个线程，我们假设先调取 Thread1，Thread1=&gt;setA( v2, 0 )方法，会使得 A 的版本号+1，即由[version=0]=&gt;[version=1]，此后 Thread2=&gt;getA( 0 )方法不会失效，注意 getA 方法不因为版本号的不一致而失败，当进行到 Thread2=&gt;setA(v3, 0)方法时，此时 setA 方法中 A 的版本号为 0，而此时将要被 set 的 A 的变量的版本号已经被 Thread1 修改为 1，0≠1，setA 方法调用失效，Thread2 会回到线程的第一步重新操作，升高变量 A 的版本号，执行 Thread2=&gt;( getA( 1 ), setA(v3, 1) )，当再次执行到 Thread2=&gt;setA(v3, 1)方法时，有操作版本号 1=存储版本号 1，此时版本号达到一致，A 变量的值更新为 v3，同时其版本号+1，即 version=2。如果 Thread2 第二次进行 setA 方法的时候，A 的版本号又被其他线程修改提升，那么 Thread2 将会继续重新执行本线程，重新 Thread2=&gt;( getA( version ), setA(v3, version ) )，如此循环，直到操作版本号和存储版本号一致为止。</p>
<p>我们可以参照下 JVM-CAS 的操作机制，在数据库字段中对 balance 字段增加一个 version 字段，当 balance 的值改变时，version 自增 1。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`studyjpa`</span>.<span class="hljs-string">`bank_account`</span><br><span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> <span class="hljs-string">`version`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'数据版本号-从0开始每次+1'</span> <span class="hljs-keyword">AFTER</span> <span class="hljs-string">`customer`</span>;<br></code></pre></td></tr></table></figure></div>

<blockquote>
<p>E-R 图</p>
</blockquote>
<p><a href="https://img.webpro.ltd/picbed/img/20210720075925.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720075925.png" class="lazyload" title></a></p>
<p>初始数据：</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720075939.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720075939.png" class="lazyload" title></a></p>
<p>此外，我们将 update 并发操作串行化，再加上数据版本控制，实现类 CAS 操作。串行化采用生产者-&gt;消费者模式，消费者并发的操作请求将会逐条用编号标记放置在计算机内存中排队等待消费者处理（该机制参考 java 的一些并发框架）。</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720075958.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720075958.png" class="lazyload" title></a></p>
<h3 id="2、并行转串行处理"><a href="#2、并行转串行处理" class="headerlink" title="2、并行转串行处理"></a>2、并行转串行处理</h3><p>我们将该过程分为以下几个关键步骤：</p>
<p>A.并发请求接收=&gt;为请求分配序号=&gt;按序号将处理的内容存储在缓存池对应的缓存块中</p>
<p>B.消费者自动处理服务循环扫描缓存块=&gt;有未处理请求进行处理</p>
<p>A、B 为两个相互不干扰的一个过程，A 作为生产者 Producer 向缓存块中不断存入数据，B 作为消费者 Consumer 从缓存块中取出数据进行处理，B 对 A 产生的请求进行异步处理。之所以设置缓存块，是因为在上面的实验环境中，要保证不产生脏数据，必须是生产者产生 1 个请求，消费者就同步处理 1 个请求，然而生产者产生请求的速度要高于消费者处理数据的速度，所以无法完成生产者&lt;=&gt;消费者之间的同步，因此请求需要排队进行异步处理。</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720080036.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720080036.png" class="lazyload" title></a></p>
<blockquote>
<p>最后在阐述几个关键性的要点：</p>
</blockquote>
<ul>
<li>为提高效率，并发请求过程中为请求分配任务序号不使用锁机制（synchronized 等）。</li>
<li>任务序号（TaskIndex）采用的是原子计数方式生成，保障并发的请求的任务序号不重复。</li>
<li>缓存块采用普通的 String[]数组（String[] Task）实现，从内存中读取缓存数据效率要高很多。</li>
<li>数组的最大长度（CoreMAX）决定着程序能够承载的最大并发数。</li>
<li>缓存块的 index 就是并发请求分配的任务序号</li>
</ul>
<p>下面用 java 代码实现：</p>
<blockquote>
<p>生产者模拟</p>
</blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><figcaption><span>TransMoneyProducer.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Bank.demo1;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransMoneyProducer</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-keyword">int</span> for_id)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"for_id = "</span> + for_id + <span class="hljs-string">" is waiting for deal"</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></div>

<blockquote>
<p>BankCore 类 - 并行转串行核心类</p>
</blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><figcaption><span>BankCore.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Bank.demo1;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * BankCore 建立缓存池，并行转串行</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BankCore</span> </span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> CoreMAX = <span class="hljs-number">1024</span>;                         <span class="hljs-comment">// 最大支持缓存数</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AtomicInteger TaskIndex = <span class="hljs-keyword">new</span> AtomicInteger();    <span class="hljs-comment">// 循环自增原子计数，为每个请求标上序号(0-1023-0-1023-...)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AtomicInteger RequestIndex = <span class="hljs-keyword">new</span> AtomicInteger(); <span class="hljs-comment">// 自增原子计数，为每个请求标上序号(用途就是和写入数组的TaskIndex对比，查看请求是否有丢失)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AtomicInteger scanIndex = <span class="hljs-keyword">new</span> AtomicInteger();    <span class="hljs-comment">// 扫描服务</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String[] Task = <span class="hljs-keyword">new</span> String[CoreMAX];              <span class="hljs-comment">// 缓存，支持1024个并发转换</span><br><br>    ExecutorService executor;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BankCore</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">// 初始化1024个缓存</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; CoreMAX; i++)&#123;<br>            Task[i] = <span class="hljs-string">""</span>;<br>        &#125;<br>        <span class="hljs-comment">// 初始化</span><br>        TaskIndex.compareAndSet(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>        RequestIndex.compareAndSet(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>        executor = Executors.newCachedThreadPool();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">NewRequest</span><span class="hljs-params">(String requestStr)</span></span>&#123;<br>        <span class="hljs-keyword">int</span> newRequestIndex = RequestIndex.incrementAndGet();<br><span class="hljs-comment">//        int newTaskIndex = newRequestIndex &amp; (CoreMAX - 1) - 1;</span><br>        <span class="hljs-keyword">int</span> newTaskIndex = TaskIndex.incrementAndGet();<br>        TaskIndex.compareAndSet(<span class="hljs-number">1024</span>, <span class="hljs-number">0</span>);<br>        System.out.println(<span class="hljs-string">"NewRequest["</span> + newRequestIndex + <span class="hljs-string">"] =&gt; ["</span> + newTaskIndex + <span class="hljs-string">"] "</span> + requestStr);<br>        <span class="hljs-comment">// 如果有空余的位子存放新请求那么就存放，否则会抛弃新请求</span><br>        <span class="hljs-keyword">if</span>(Task[newTaskIndex].equals(<span class="hljs-string">""</span>))&#123;<br>            Task[newTaskIndex] = requestStr;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 异步自动处理请求开始</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AutoListenStart</span><span class="hljs-params">()</span></span>&#123;<br>        executor.submit(() -&gt; &#123;<br>            System.out.println(<span class="hljs-string">"new Thread AutoListenStart"</span>);<br>            <span class="hljs-comment">// 阻塞，循环扫描第0-1023处缓存</span><br>            <span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>                <span class="hljs-keyword">int</span> task_index = scanIndex.get();<br>                <span class="hljs-keyword">if</span>(!Task[task_index].equals(<span class="hljs-string">""</span>))&#123;<br>                    <span class="hljs-comment">// 有新任务</span><br>                    Thread.sleep(<span class="hljs-number">50</span>);<br>                    System.out.println(<span class="hljs-string">"TaskIndex = "</span> + task_index + <span class="hljs-string">" ["</span> + Task[task_index] + <span class="hljs-string">"]"</span> + <span class="hljs-string">" | 已处理"</span>);<br>                    Task[task_index] = <span class="hljs-string">""</span>;<br>                &#125;<br>                scanIndex.incrementAndGet();<br>                scanIndex.compareAndSet(<span class="hljs-number">1024</span>, <span class="hljs-number">0</span>);<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 停止listen</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shutdownNow</span><span class="hljs-params">()</span></span>&#123;<br>        executor.shutdownNow();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></div>

<ul>
<li>我们建立了一个 1024 长度的缓存池，可以承载 1024 个并发。</li>
<li>NewRequest 方法：并发线程提交请求，即[并发接收池=&gt;存入缓存]。</li>
<li>AutoListenStart 方法是一个独立的线程，当其被启动后，它会在后台持续扫描缓存池，以单线程的方式处理新请求。</li>
<li>AutoListenStart 方法处理新请求完毕后，会清空对应的缓存块，这也是判断缓存块中是否有未处理请求的依据。</li>
<li>AutoListenStart 方法在处理请求的时候，延时 50ms，假设处理数据花了 50ms。</li>
</ul>
<p>下面我们测试一下：</p>
<p>新建 DemoTest1 类，模拟并发请求：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><figcaption><span>DemoTest1.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Bank.demo1;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DemoTest1</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br><br>        ExecutorService executor1 = Executors.newCachedThreadPool();<br>        BankCore bankCore = <span class="hljs-keyword">new</span> BankCore();<br>        TransMoneyProducer transMoneyProducer = <span class="hljs-keyword">new</span> TransMoneyProducer();<br><br>        bankCore.AutoListenStart();<br><br>        <span class="hljs-comment">// 开启并发线程模拟</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++)&#123;<br>            <span class="hljs-keyword">int</span> ii = i;<br>            executor1.submit(() -&gt; &#123;<br>                bankCore.NewRequest(transMoneyProducer.test(ii));<br>            &#125;);<br>        &#125;<br><br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        System.out.println(<span class="hljs-string">"RequestIndex Max: "</span>+ BankCore.RequestIndex.get());<br>        System.out.println(<span class="hljs-string">"TaskIndex Max: "</span>+ BankCore.TaskIndex.get());<br><br>        executor1.shutdownNow();<br>        bankCore.shutdownNow();<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></div>

<p>运行，看下 Console 输出如下：</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720080252.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720080252.png" class="lazyload" title></a></p>
<p>我们可以看到并发产生的请求 NewRequest 有条不紊的被我们的 AutoListenStart 处理成功，10 个并发线程一个都没有丢失，都被正确的处理了。</p>
<h3 id="3、应用上述算法处理并发转账引起的脏数据"><a href="#3、应用上述算法处理并发转账引起的脏数据" class="headerlink" title="3、应用上述算法处理并发转账引起的脏数据"></a>3、应用上述算法处理并发转账引起的脏数据</h3><blockquote>
<p>Ⅰ、TransMoneyProducer 生产者</p>
</blockquote>
<p>一个正式方法：newTrans</p>
<p><strong>TransMoneyProducer.newTrans(senderCardNumber, receiverCardNumber, transCount)</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><figcaption><span>TransMoneyProducer.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Bank.demo1;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransMoneyProducer</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">newTrans</span><span class="hljs-params">(String senderCardNumber, String receiverCardNumber, <span class="hljs-keyword">int</span> transCount)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> senderCardNumber + <span class="hljs-string">"#"</span> + receiverCardNumber + <span class="hljs-string">"#"</span> + transCount;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-keyword">int</span> for_id)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"for_id = "</span> + for_id + <span class="hljs-string">" is waiting for deal"</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></div>

<blockquote>
<p>Ⅱ、TransMoneyConsumer 消费者</p>
</blockquote>
<p>消费者类不需要支持多线程，按照单线程正常的代码结构即可</p>
<p>使用方法：直接调用 TransMoneyConsumer 对象，传入发送者卡号、接收者卡号、金额即可</p>
<p><strong>new TransMoneyConsumer(senderCardNumber, receiverCardNumber, transCount)</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><figcaption><span>TransMoneyConsumer.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Bank.demo1;<br><br><span class="hljs-keyword">import</span> Bank.dbBean.accountSuper;<br><br><span class="hljs-keyword">import</span> java.sql.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 转战类</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransMoneyConsumer</span> </span>&#123;<br><br>    <span class="hljs-comment">// 参数配置</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String dbName    =   <span class="hljs-string">"studyjpa"</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL       =   <span class="hljs-string">"jdbc:mysql://127.0.0.1:3306/"</span> + dbName + <span class="hljs-string">"?useUnicode=true&amp;characterEncoding=UTF-8"</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String user      =   <span class="hljs-string">"root"</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String password  =   <span class="hljs-string">"root"</span>;<br>    <span class="hljs-comment">// 数据库句柄</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection conn;<br>    <span class="hljs-comment">// SQL模板</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> PreparedStatement sql;<br>    <span class="hljs-comment">// res</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ResultSet res;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 转账操作初始化</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> String senderCardNumber</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> String receiverCardNumber</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> int transCount</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TransMoneyConsumer</span><span class="hljs-params">(String senderCardNumber, String receiverCardNumber, <span class="hljs-keyword">int</span> transCount)</span></span>&#123;<br>        openConn();<br>        doTrans(senderCardNumber, receiverCardNumber, transCount);<br>        System.out.println(<span class="hljs-string">"------------------------"</span>);<br>        System.out.println(<span class="hljs-string">"TransMoney1 is Construct"</span>);<br>        System.out.println(<span class="hljs-string">"receiverCardNumber: "</span> + receiverCardNumber);<br>        System.out.println(<span class="hljs-string">"------------------------"</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 打开数据库连接</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">openConn</span><span class="hljs-params">()</span></span>&#123;<br>        pl(<span class="hljs-string">"openConn"</span>);<br>        <span class="hljs-keyword">try</span>&#123;<br>            Class.forName(<span class="hljs-string">"com.mysql.jdbc.Driver"</span>); <span class="hljs-comment">// 加载驱动</span><br>        &#125;<span class="hljs-keyword">catch</span>(ClassNotFoundException e) &#123;<br>            <span class="hljs-comment">// 捕捉到错误</span><br>            System.out.println(<span class="hljs-string">"ClassNotFoundException!"</span> + e);<br>        &#125;<br>        <span class="hljs-comment">// 连接至数据库</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            conn = DriverManager.getConnection(URL, user, password);<br>            conn.setAutoCommit(<span class="hljs-keyword">false</span>);<br><span class="hljs-comment">//            System.out.println(dbName + " opened SUCCESS");</span><br>        &#125;<span class="hljs-keyword">catch</span>(SQLException e) &#123;<br>            <span class="hljs-comment">// 捕捉到错误</span><br>            System.out.println(dbName + <span class="hljs-string">" opened error!"</span> + e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过卡号查询信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> String cardNumber</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> account account</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> accountSuper <span class="hljs-title">findByCardNumber</span><span class="hljs-params">(String cardNumber)</span></span>&#123;<br>        accountSuper r = <span class="hljs-keyword">new</span> accountSuper();<br>        <span class="hljs-keyword">try</span>&#123;<br>            <span class="hljs-comment">// 执行SQL语句</span><br>            sql = conn.prepareStatement(<span class="hljs-string">"SELECT  `id`, `balance`, `card_number`, `customer`, `version` FROM `bank_account` WHERE `card_number`=?"</span>);<br>            sql.setString(<span class="hljs-number">1</span>, cardNumber);<br>            res = sql.executeQuery();<br>            <span class="hljs-keyword">if</span>(res.next())&#123;<br>                r.setId(res.getInt(<span class="hljs-string">"id"</span>));<br>                r.setBalance(res.getInt(<span class="hljs-string">"balance"</span>));<br>                r.setCard_number(res.getString(<span class="hljs-string">"card_number"</span>));<br>                r.setCustomer(res.getString(<span class="hljs-string">"customer"</span>));<br>                r.setVersion(res.getInt(<span class="hljs-string">"version"</span>));<br>            &#125;<br>            res.close();<br>            <span class="hljs-keyword">if</span>(conn.isClosed())&#123;<br>                openConn();<br>            &#125;<br>        &#125;<span class="hljs-keyword">catch</span>(Exception e) &#123;<br>            <span class="hljs-comment">// 捕捉到错误</span><br>            System.out.println(<span class="hljs-string">"Exception! FROM SELECT : "</span> + e + <span class="hljs-string">" card_number: "</span> + cardNumber);<br>        &#125;<br>        <span class="hljs-keyword">return</span> r;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 转账</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doTrans</span><span class="hljs-params">(String senderCardNumber, String receiverCardNumber, <span class="hljs-keyword">int</span> transCount)</span></span>&#123;<br>        accountSuper sender = findByCardNumber(senderCardNumber);<br>        accountSuper receiver = findByCardNumber(receiverCardNumber);<br>        <span class="hljs-keyword">int</span> sender_id = sender.getId();<br>        <span class="hljs-keyword">int</span> receiver_id = receiver.getId();<br>        <span class="hljs-comment">// 执行转账</span><br>        <span class="hljs-keyword">int</span> senderBalance = sender.getBalance();<br>        <span class="hljs-keyword">int</span> receiverBalance = receiver.getBalance();<br>        <span class="hljs-comment">// sender 账户余额是否充足</span><br>        <span class="hljs-keyword">if</span> (senderBalance - transCount &gt;= <span class="hljs-number">0</span>) &#123;<br>            senderBalance -= transCount;<br>            receiverBalance += transCount;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 构造sender-SQL模板</span><br>                PreparedStatement sender_sql =<br>                        conn.prepareStatement(<span class="hljs-string">"UPDATE `bank_account` SET `balance`=?, version=version+1 WHERE `id`=?"</span>);<br>                <span class="hljs-comment">// 填充模板</span><br>                sender_sql.setInt(<span class="hljs-number">1</span>, senderBalance);<br>                sender_sql.setInt(<span class="hljs-number">2</span>, sender_id);<br>                sender_sql.executeUpdate();<br><br>                <span class="hljs-comment">// 构造receiver-SQL模板</span><br>                PreparedStatement receiver_sql =<br>                        conn.prepareStatement(<span class="hljs-string">"UPDATE `bank_account` SET `balance`=?, version=version+1 WHERE `id`=?"</span>);<br>                <span class="hljs-comment">// 填充模板</span><br>                receiver_sql.setInt(<span class="hljs-number">1</span>, receiverBalance);<br>                receiver_sql.setInt(<span class="hljs-number">2</span>, receiver_id);<br>                receiver_sql.executeUpdate();<br>                <span class="hljs-comment">// 执行事务</span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    conn.commit();<br>                    getTradePrint(<span class="hljs-string">"√ TransMoney Success"</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>                    <span class="hljs-comment">// 捕捉到错误</span><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        conn.rollback();<br>                        getTradePrint(<span class="hljs-string">"×× new Thread update fail: "</span> + e + <span class="hljs-string">", been rollback!"</span>);<br>                    &#125; <span class="hljs-keyword">catch</span> (SQLException e1) &#123;<br>                        getTradePrint(<span class="hljs-string">"××× new Thread update fail: "</span> + e + <span class="hljs-string">", rollback fail!: "</span> + e1);<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>                <span class="hljs-comment">// 捕捉到错误</span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    conn.rollback();<br>                    getTradePrint(<span class="hljs-string">"×× SQLException: "</span> + e + <span class="hljs-string">", been rollback! "</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (SQLException e1) &#123;<br>                    getTradePrint(<span class="hljs-string">"××× SQLException: "</span> + e + <span class="hljs-string">", rollback fail: "</span> + e1);<br>                &#125;<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-comment">// 余额不足</span><br>            getTradePrint(sender.getCard_number() + <span class="hljs-string">"=&gt;Trans=&gt;"</span> + receiver.getCard_number() + <span class="hljs-string">" Balance cannot afford"</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getTradePrint</span><span class="hljs-params">(String resString)</span></span>&#123;<br><span class="hljs-comment">//        System.out.println("------------------------");</span><br><span class="hljs-comment">//        System.out.println("&gt;&gt;&gt;" + resString);</span><br><span class="hljs-comment">//        System.out.println("Sender: " + sender.getCard_number() + "receiver: " + receiver.getCard_number());</span><br><span class="hljs-comment">//        System.out.println("SenderName: " + sender.getCustomer() + "receiverName: " + receiver.getCustomer());</span><br><span class="hljs-comment">//        System.out.println("TransMoney: ￥" + deltaMoney);</span><br><span class="hljs-comment">//        System.out.println("sender balance: ￥" + sender.getBalance() + " =&gt; ￥" + findByCardNumber(sender.getCard_number()).getBalance());</span><br><span class="hljs-comment">//        System.out.println("receiver balance: ￥" + receiver.getBalance() + " =&gt; ￥" + findByCardNumber(receiver.getCard_number()).getBalance());</span><br><span class="hljs-comment">//        System.out.println("------------------------");</span><br>        System.out.println(resString);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pl</span><span class="hljs-params">(String s)</span></span>&#123;<br>        System.out.println(s);<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure></div>

<blockquote>
<p>Ⅲ、并行=&gt;串行转换核心代码</p>
</blockquote>
<p>BankCore1 类</p>
<p>使用方法：初始化对象后，首先调用 AutoListenStart 进行后台扫描缓存，有新请调用 NewRequest 方法</p>
<p><strong>BankCore1.AutoListenStart()</strong></p>
<p><strong>BankCore1.NewRequest(requestStr)</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><figcaption><span>BankCore1.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Bank.demo1;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BankCore1</span> </span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> CoreMAX = <span class="hljs-number">1024</span>;                         <span class="hljs-comment">// 最大支持缓存数</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AtomicInteger TaskIndex = <span class="hljs-keyword">new</span> AtomicInteger();    <span class="hljs-comment">// 循环自增原子计数，为每个请求标上序号(0-1023-0-1023-...)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AtomicInteger RequestIndex = <span class="hljs-keyword">new</span> AtomicInteger(); <span class="hljs-comment">// 自增原子计数，为每个请求标上序号(用途就是和写入数组的TaskIndex对比，查看请求是否有丢失)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AtomicInteger scanIndex = <span class="hljs-keyword">new</span> AtomicInteger();    <span class="hljs-comment">// 扫描服务</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String[] Task = <span class="hljs-keyword">new</span> String[CoreMAX];              <span class="hljs-comment">// 缓存，支持1024个并发转换</span><br><br>    ExecutorService executor;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BankCore1</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">// 初始化1024个缓存</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; CoreMAX; i++)&#123;<br>            Task[i] = <span class="hljs-string">""</span>;<br>        &#125;<br>        <span class="hljs-comment">// 初始化</span><br>        TaskIndex.compareAndSet(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>        RequestIndex.compareAndSet(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>        executor = Executors.newCachedThreadPool();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">NewRequest</span><span class="hljs-params">(String requestStr)</span></span>&#123;<br>        <span class="hljs-keyword">int</span> newRequestIndex = RequestIndex.incrementAndGet();<br><span class="hljs-comment">//        int newTaskIndex = newRequestIndex &amp; (CoreMAX - 1) - 1;</span><br>        <span class="hljs-keyword">int</span> newTaskIndex = TaskIndex.incrementAndGet();<br>        TaskIndex.compareAndSet(<span class="hljs-number">1024</span>, <span class="hljs-number">0</span>);<br>        System.out.println(<span class="hljs-string">"NewRequest["</span> + newRequestIndex + <span class="hljs-string">"] =&gt; ["</span> + newTaskIndex + <span class="hljs-string">"] "</span> + requestStr);<br>        <span class="hljs-comment">// 如果有空余的位子存放新请求那么就存放，否则会抛弃新请求</span><br>        <span class="hljs-keyword">if</span>(Task[newTaskIndex].equals(<span class="hljs-string">""</span>))&#123;<br>            Task[newTaskIndex] = requestStr;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 异步自动处理请求开始</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AutoListenStart</span><span class="hljs-params">()</span></span>&#123;<br>        executor.submit(() -&gt; &#123;<br>            System.out.println(<span class="hljs-string">"new Thread AutoListenStart"</span>);<br>            <span class="hljs-comment">// 阻塞，循环扫描第0-1023处缓存</span><br>            <span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>)&#123;<br>                <span class="hljs-keyword">int</span> task_index = scanIndex.get();<br>                <span class="hljs-keyword">if</span>(!Task[task_index].equals(<span class="hljs-string">""</span>))&#123;<br>                    <span class="hljs-comment">// 分割信息</span><br>                    <span class="hljs-comment">// 任务格式 转账卡号#收款卡号#金额</span><br>                    String[] deal = Task[task_index].split(<span class="hljs-string">"#"</span>);<br>                    String senderCardNumber = deal[<span class="hljs-number">0</span>];<br>                    String receiverCardNumber = deal[<span class="hljs-number">1</span>];<br>                    <span class="hljs-keyword">int</span> transCount = Integer.parseInt(deal[<span class="hljs-number">2</span>]);<br>                    <span class="hljs-keyword">new</span> TransMoneyConsumer(senderCardNumber, receiverCardNumber, transCount);<br>                    System.out.println(<span class="hljs-string">"TaskIndex = "</span> + task_index + <span class="hljs-string">" ["</span> + Task[task_index] + <span class="hljs-string">"]"</span> + <span class="hljs-string">" | 已处理"</span>);<br>                    Task[task_index] = <span class="hljs-string">""</span>;<br>                &#125;<br>                scanIndex.incrementAndGet();<br>                scanIndex.compareAndSet(<span class="hljs-number">1024</span>, <span class="hljs-number">0</span>);<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 停止listen</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shutdownNow</span><span class="hljs-params">()</span></span>&#123;<br>        executor.shutdownNow();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></div>

<blockquote>
<p>Ⅳ、组合 Ⅰ,Ⅱ,Ⅲ，即生产者=&gt;缓存池=&gt;消费者 模式</p>
</blockquote>
<p>DemoTest2 类</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><figcaption><span>DemoTest2.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> Bank.demo1;<br><br><br><span class="hljs-keyword">import</span> java.util.concurrent.ExecutorService;<br><span class="hljs-keyword">import</span> java.util.concurrent.Executors;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DemoTest2</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br><br>        ExecutorService executor1 = Executors.newCachedThreadPool();<br>        String sender = <span class="hljs-string">"1000"</span>;<br>        String Lisi = <span class="hljs-string">"1001"</span>;<br>        String WangWu = <span class="hljs-string">"1002"</span>;<br>        String ZhaoLiu = <span class="hljs-string">"1003"</span>;<br>        String[] acc = <span class="hljs-keyword">new</span> String[<span class="hljs-number">3</span>];<br>        acc[<span class="hljs-number">0</span>] = Lisi;<br>        acc[<span class="hljs-number">1</span>] = WangWu;<br>        acc[<span class="hljs-number">2</span>] = ZhaoLiu;<br><br>        BankCore1 bankCore = <span class="hljs-keyword">new</span> BankCore1();<br>        TransMoneyProducer transMoneyProducer = <span class="hljs-keyword">new</span> TransMoneyProducer();<br>        bankCore.AutoListenStart();<br><br>        <span class="hljs-comment">// 开启并发线程模拟</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">6</span>; i++)&#123;<br>            <span class="hljs-keyword">int</span> ii = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">if</span>(i &lt; <span class="hljs-number">3</span>)&#123;<br>                ii = i;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                ii = i - <span class="hljs-number">3</span>;<br>            &#125;<br>            String receiver = acc[ii];<br>            executor1.submit(() -&gt; &#123;<br>                bankCore.NewRequest(transMoneyProducer.newTrans(sender, receiver, <span class="hljs-number">100</span>));<br>            &#125;);<br>        &#125;<br><br>        Thread.sleep(<span class="hljs-number">2000</span>);<br>        System.out.println(<span class="hljs-string">"RequestIndex Max: "</span>+ BankCore1.RequestIndex.get());<br>        System.out.println(<span class="hljs-string">"TaskIndex Max: "</span>+ BankCore1.TaskIndex.get());<br><br>        executor1.shutdownNow();<br>        bankCore.shutdownNow();<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></div>

<p>我们这次进行 6 线程并发测试，张三并发向李四、王五、赵六转账两次，即</p>
<a href="https://img.webpro.ltd/picbed/img/20210720080545.png" target="_blank" rel="noopener" data-fancybox="group" data-caption="undefined" class="fancybox"><img width="318" height="493" style data-src="https://img.webpro.ltd/picbed/img/20210720080545.png" class="lazyload"></a>

<p>理论上讲，转账过后，张三的余额为 0，李四/王五/赵六的其中两人账户余额为 100，另外一个人账户余额为 0，Console 会有账户余额不足提示 4 次。</p>
<p>重置数据库中的数据：</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720080558.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720080558.png" class="lazyload" title></a></p>
<p>我们接下来运行一下，得到 Console 打印结果：</p>
<pre>
new Thread AutoListenStart
NewRequest[2] => [2] 1000#1002#100
NewRequest[1] => [1] 1000#1001#100
NewRequest[3] => [3] 1000#1003#100
NewRequest[4] => [4] 1000#1001#100
NewRequest[5] => [5] 1000#1002#100
NewRequest[6] => [6] 1000#1003#100
openConn
√ TransMoney Success
------------------------
TransMoney1 is Construct
receiverCardNumber: 1001
------------------------
TaskIndex = 1 [1000#1001#100] | 已处理
openConn
√ TransMoney Success
------------------------
TransMoney1 is Construct
receiverCardNumber: 1002
------------------------
TaskIndex = 2 [1000#1002#100] | 已处理
openConn
1000=>Trans=>1003 Balance cannot afford
------------------------
TransMoney1 is Construct
receiverCardNumber: 1003
------------------------
TaskIndex = 3 [1000#1003#100] | 已处理
openConn
1000=>Trans=>1001 Balance cannot afford
------------------------
TransMoney1 is Construct
receiverCardNumber: 1001
------------------------
TaskIndex = 4 [1000#1001#100] | 已处理
openConn
1000=>Trans=>1002 Balance cannot afford
------------------------
TransMoney1 is Construct
receiverCardNumber: 1002
------------------------
TaskIndex = 5 [1000#1002#100] | 已处理
openConn
1000=>Trans=>1003 Balance cannot afford
------------------------
TransMoney1 is Construct
receiverCardNumber: 1003
------------------------
TaskIndex = 6 [1000#1003#100] | 已处理
RequestIndex Max: 6
TaskIndex Max: 6

Process finished with exit code 1
</pre>

<p>数据表数据变化如下：</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720081223.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720081223.png" class="lazyload" title></a></p>
<p>经过多次运行测试，均是正常的转出两次 100，再转出开始提示余额不足（最后那个版本号 version 暂时没有用到，因为我们并行转串行后就不需要考虑数据版本的问题了）</p>
<p>可见我们这种并行转串行的算法生效了。下面我们通过几个示意图总结一下上述算法的流程：</p>
<p><a href="https://img.webpro.ltd/picbed/img/20210720081244.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt data-src="https://img.webpro.ltd/picbed/img/20210720081244.png" class="lazyload" title></a></p>
<p>===</p>
<p>当然并行转串行只是众多方法的一种。</p>
<p>===</p>
<h1 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h1><ul>
<li><p>该方法最大的特点就是实现无锁高并发，适用于一些小规模的并发场景。</p>
</li>
<li><p>TaskTool 扫描 Task 的方法比较耗费资源，当高并发条件下当然没有问题，但是当并发数较低或没有并发时，应当适当降低扫描消耗。</p>
</li>
<li><p>基于 2 条，应当为 TaskPool 设置自动调速算法，合理利用计算机资源。</p>
</li>
<li><p>学海无涯，仍然有很多知识等待我们去学习思考。</p>
</li>
</ul>
<p>===</p>
<p>===</p>
<blockquote>
<p>2019-06-10 18:18:23 毕</p>
</blockquote>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Bill</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://blog.webpro.ltd/2019/06/07/ewallet-concurrency-java-mysql/">http://blog.webpro.ltd/2019/06/07/ewallet-concurrency-java-mysql/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://blog.webpro.ltd">Bill's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%B9%B6%E5%8F%91/">并发    </a></div><div class="post_share"><div class="social-share" data-image="https://img.webpro.ltd/picbed/img/20210720081536.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/08/09/Linux-c-review1/"><img class="prev_cover lazyload" data-src="https://img.webpro.ltd/picbed/img/20200312101338.png" onerror="onerror=null;src='https://img.webpro.ltd/picbed/img/20200308222851.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Linux c 程序设计考试 复习</span></div></a></div><div class="next-post pull_right"><a href="/2019/05/29/get-my-site-pageview/"><img class="next_cover lazyload" data-src="https://img.webpro.ltd/picbed/img/20200312095556.png" onerror="onerror=null;src='https://img.webpro.ltd/picbed/img/20200308222851.jpg'"><div class="label">下一篇</div><div class="next_info"><span>写个网站流量统计插件</span></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var createIssueManually = false == true ? true : false;
var distractionFreeMode = false == true ? true : false;
var gitalk = new Gitalk({
  clientID: document.domain == 'cn.blog.webpro.ltd' ? 'c61a2752586ce23ef4cb' : '7db6d80f4f95761969f5',
  clientSecret: document.domain == 'cn.blog.webpro.ltd' ? 'd5b1e214f9a600954b0ae9fac6dcbddb02f484be' : '3e0e2ca6e22e762d50dfd210a50cd5e0a3e473ae',
  repo: 'billwhite246.github.io',
  owner: 'billwhite246',
  admin: 'billwhite246',
  id: md5(decodeURI(location.pathname)),
  createIssueManually: createIssueManually,
  distractionFreeMode: distractionFreeMode,
  language: 'zh-CN',
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
}</script></div></div></main><footer id="footer" style="background-image: url(https://img.webpro.ltd/picbed/img/20210720081536.png)" data-type="photo"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-6606077988466334',
  enable_page_level_ads: 'true'
});</script></script><div id="footer-wrap"><div class="copyright">Copyright&copy;2017 - 2021 By Bill</div><div class="framework-info"><span id="who_powered"></span></div><div class="footer_custom_text">Hi, Welcome To Visit My Site! - webpro.ltd</div><div class="icp"><a href="https://us.blog.webpro.ltd/" target="_blank" rel="noopener"><span>备用线路 - us.blog.webpro.ltd</span></a></div><div class="icp"><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener"><img class="icp-icon" src="/img/icp.png"><span>皖ICP备2021000564号-1</span></a></div><div id="wnzz"></div>
<script async id="slcLiveChat" src="https://widget.sonetel.com/SonetelWidget.min.js" data-account-id="207238753"></script></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/bluebird.js"></script><script src="/js/html2canvas.min.js"></script><script src="/js/div2img.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>