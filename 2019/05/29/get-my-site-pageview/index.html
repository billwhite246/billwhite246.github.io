<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>写个网站流量统计插件 | Bill's blog</title><meta name="description" content="写个网站流量统计插件"><meta name="keywords" content="php"><meta name="author" content="Bill"><meta name="copyright" content="Bill"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="http://ta.qq.com"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><meta name="twitter:card" content="summary"><meta name="twitter:title" content="写个网站流量统计插件"><meta name="twitter:description" content="写个网站流量统计插件"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200312095556.png"><meta property="og:type" content="article"><meta property="og:title" content="写个网站流量统计插件"><meta property="og:url" content="http://blog.webpro.ltd/2019/05/29/get-my-site-pageview/"><meta property="og:site_name" content="Bill's blog"><meta property="og:description" content="写个网站流量统计插件"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200312095556.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = '2'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="http://blog.webpro.ltd/2019/05/29/get-my-site-pageview/"><link rel="prev" title="Linux c 程序设计考试 复习" href="http://blog.webpro.ltd/2019/08/09/Linux-c-review1/"><link rel="next" title="OrangePi Zero嵌入式板搭建微服务网关[Ubuntu_Server1504+JDK1.8]" href="http://blog.webpro.ltd/2019/05/26/OrangePi-Zero-run-springboot/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script src="https://tajs.qq.com/stats?sId=66527705" charset="UTF-8"></script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: document.domain == 'billwhite246.gitee.io' ? '/my-blog' : '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"title":"Snackbar.bookmark.title","message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#232323","bgDark":"#2d3035","position":"top-center"},
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Bill's blog" type="application/atom+xml">
</head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Bill's blog</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-list-ul"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-calendar-o"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-folder" aria-hidden="true"></i><span> AHUT</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/2020/03/12/unix-study/"><i class="fa-fw fa fa-file-pdf-o"></i><span> UNIX网络编程作业本</span></a></li><li><a class="site-page" href="/"><i class="fa-fw fa fa-file-pdf-o"></i><span> 2019-07-13实习培训(Python)</span></a></li><li><a class="site-page" href="/%E5%AF%BC%E5%B8%88%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0/"><i class="fa-fw fa fa-file-pdf-o"></i><span> 导师项目学习</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-folder" aria-hidden="true"></i><span> 文件夹</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="https://www.webpro.ltd/blog/static/arduino-esp8266-latest/" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> ESP8266核心文档</span></a></li><li><a class="site-page" href="/2019/09/29/study-datastructure/"><i class="fa-fw fa fa-file-pdf-o"></i><span> 数据结构</span></a></li><li><a class="site-page" href="/sims/"><i class="fa-fw fa fa-file-pdf-o"></i><span> sims项目参数</span></a></li><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/Android开发规范.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> Android开发规范</span></a></li><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/java开发规范.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> java开发规范</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-book" aria-hidden="true"></i><span> 文章</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 文章归档</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">18</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">25</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">10</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-list-ul"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-calendar-o"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-folder" aria-hidden="true"></i><span> AHUT</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/2020/03/12/unix-study/"><i class="fa-fw fa fa-file-pdf-o"></i><span> UNIX网络编程作业本</span></a></li><li><a class="site-page" href="/"><i class="fa-fw fa fa-file-pdf-o"></i><span> 2019-07-13实习培训(Python)</span></a></li><li><a class="site-page" href="/%E5%AF%BC%E5%B8%88%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0/"><i class="fa-fw fa fa-file-pdf-o"></i><span> 导师项目学习</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-folder" aria-hidden="true"></i><span> 文件夹</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="https://www.webpro.ltd/blog/static/arduino-esp8266-latest/" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> ESP8266核心文档</span></a></li><li><a class="site-page" href="/2019/09/29/study-datastructure/"><i class="fa-fw fa fa-file-pdf-o"></i><span> 数据结构</span></a></li><li><a class="site-page" href="/sims/"><i class="fa-fw fa fa-file-pdf-o"></i><span> sims项目参数</span></a></li><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/Android开发规范.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> Android开发规范</span></a></li><li><a class="site-page" href="https://cdn.jsdelivr.net/gh/billwhite246/billwhite246.github.io@master/pan/pdf/java开发规范.pdf" target="_blank" rel="noopener"><i class="fa-fw fa fa-file-pdf-o"></i><span> java开发规范</span></a></li></ul></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-book" aria-hidden="true"></i><span> 文章</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 文章归档</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#插件效果"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">插件效果</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#统计数据分析"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">统计数据分析</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#计算方法"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">计算方法</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#如何准确获取到客户端IP"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">如何准确获取到客户端IP</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#将搜狐提供的js嵌入到网页，访问结果如下"><span class="toc_mobile_items-number">3.1.1.</span> <span class="toc_mobile_items-text">将搜狐提供的js嵌入到网页，访问结果如下:</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#通过returnCitySN获取ip、cname"><span class="toc_mobile_items-number">3.1.2.</span> <span class="toc_mobile_items-text">通过returnCitySN获取ip、cname</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#后端存储方法"><span class="toc_mobile_items-number">3.2.</span> <span class="toc_mobile_items-text">后端存储方法</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#wnzz-visit表（直接存储访问记录）"><span class="toc_mobile_items-number">3.2.1.</span> <span class="toc_mobile_items-text">wnzz_visit表（直接存储访问记录）</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#wnzz-cal表（聚合一天的数据，存储计算结果）"><span class="toc_mobile_items-number">3.2.2.</span> <span class="toc_mobile_items-text">wnzz_cal表（聚合一天的数据，存储计算结果）</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#计算IP、PV"><span class="toc_mobile_items-number">3.3.</span> <span class="toc_mobile_items-text">计算IP、PV</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#计算当前在线人数"><span class="toc_mobile_items-number">3.4.</span> <span class="toc_mobile_items-text">计算当前在线人数</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#插件总体代码实现"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">插件总体代码实现</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#前端（js）"><span class="toc_mobile_items-number">4.1.</span> <span class="toc_mobile_items-text">前端（js）</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#后端"><span class="toc_mobile_items-number">4.2.</span> <span class="toc_mobile_items-text">后端</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#在要统计的页面中安装"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">在要统计的页面中安装</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#在合适位置添加统计代码"><span class="toc_mobile_items-number">5.1.</span> <span class="toc_mobile_items-text">在合适位置添加统计代码</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#插件测试"><span class="toc_mobile_items-number">5.2.</span> <span class="toc_mobile_items-text">插件测试</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#插件效果"><span class="toc-number">1.</span> <span class="toc-text">插件效果</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#统计数据分析"><span class="toc-number">2.</span> <span class="toc-text">统计数据分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#计算方法"><span class="toc-number">3.</span> <span class="toc-text">计算方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#如何准确获取到客户端IP"><span class="toc-number">3.1.</span> <span class="toc-text">如何准确获取到客户端IP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#将搜狐提供的js嵌入到网页，访问结果如下"><span class="toc-number">3.1.1.</span> <span class="toc-text">将搜狐提供的js嵌入到网页，访问结果如下:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通过returnCitySN获取ip、cname"><span class="toc-number">3.1.2.</span> <span class="toc-text">通过returnCitySN获取ip、cname</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#后端存储方法"><span class="toc-number">3.2.</span> <span class="toc-text">后端存储方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#wnzz-visit表（直接存储访问记录）"><span class="toc-number">3.2.1.</span> <span class="toc-text">wnzz_visit表（直接存储访问记录）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wnzz-cal表（聚合一天的数据，存储计算结果）"><span class="toc-number">3.2.2.</span> <span class="toc-text">wnzz_cal表（聚合一天的数据，存储计算结果）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#计算IP、PV"><span class="toc-number">3.3.</span> <span class="toc-text">计算IP、PV</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#计算当前在线人数"><span class="toc-number">3.4.</span> <span class="toc-text">计算当前在线人数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#插件总体代码实现"><span class="toc-number">4.</span> <span class="toc-text">插件总体代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前端（js）"><span class="toc-number">4.1.</span> <span class="toc-text">前端（js）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#后端"><span class="toc-number">4.2.</span> <span class="toc-text">后端</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#在要统计的页面中安装"><span class="toc-number">5.</span> <span class="toc-text">在要统计的页面中安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#在合适位置添加统计代码"><span class="toc-number">5.1.</span> <span class="toc-text">在合适位置添加统计代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#插件测试"><span class="toc-number">5.2.</span> <span class="toc-text">插件测试</span></a></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200312095556.png)"><div id="post-info"><div id="post-title"><div class="posttitle">写个网站流量统计插件</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2019-05-29<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-03-12</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/php/">php</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="插件效果"><a href="#插件效果" class="headerlink" title="插件效果"></a>插件效果</h1><ul>
<li>闲来无事写个简易网站流量统计插件:</li>
<li>开发用到: php mysql js html</li>
<li>效果如下</li>
</ul>
<p><a href="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200310162203.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200310162203.png" class="lazyload"></a></p>
<ul>
<li><input checked disabled type="checkbox"> 简易的流量统计插件，数据大致参考即可，没有高级算法，仅统计下IP和PV</li>
<li><input checked disabled type="checkbox"> 不防刷，用软件数据分分钟刷上去</li>
<li><input checked disabled type="checkbox"> 插件非常轻，对网站加载速度影响大概在5ms左右</li>
</ul>
<h1 id="统计数据分析"><a href="#统计数据分析" class="headerlink" title="统计数据分析"></a>统计数据分析</h1><ol>
<li>今日IP</li>
<li>今日PV</li>
<li>昨日IP</li>
<li>昨日PV</li>
<li>当前在线</li>
</ol>
<h1 id="计算方法"><a href="#计算方法" class="headerlink" title="计算方法"></a>计算方法</h1><h2 id="如何准确获取到客户端IP"><a href="#如何准确获取到客户端IP" class="headerlink" title="如何准确获取到客户端IP"></a>如何准确获取到客户端IP</h2><blockquote>
<p>统计IP需要获取到客户端真实的IP地址，仅js实现效果并不好。在这里我采用了[搜狐]的接口</p>
</blockquote>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">"https://pv.sohu.com/cityjson?ie=utf-8"</span>&gt;&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="将搜狐提供的js嵌入到网页，访问结果如下"><a href="#将搜狐提供的js嵌入到网页，访问结果如下" class="headerlink" title="将搜狐提供的js嵌入到网页，访问结果如下:"></a>将搜狐提供的js嵌入到网页，访问结果如下:</h3><p><a href="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200310162450.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200310162450.png" class="lazyload"></a></p>
<ul>
<li>直接返回了一个 returnCitySN 对象，我们可以获得准确的IP地址、cid(cid是什么给我留言)、地区</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> returnCitySN = &#123;<span class="string">"cip"</span>: <span class="string">"223.241.141.73"</span>, <span class="string">"cid"</span>: <span class="string">"340000"</span>, <span class="string">"cname"</span>: <span class="string">"安徽省"</span>&#125;;</span><br></pre></td></tr></table></figure></div>

<h3 id="通过returnCitySN获取ip、cname"><a href="#通过returnCitySN获取ip、cname" class="headerlink" title="通过returnCitySN获取ip、cname"></a>通过returnCitySN获取ip、cname</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ip = returnCitySN.cip;</span><br><span class="line"><span class="keyword">var</span> cname = returnCitySN.cname;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>至此，IP已经拿到</p>
</blockquote>
<h2 id="后端存储方法"><a href="#后端存储方法" class="headerlink" title="后端存储方法"></a>后端存储方法</h2><ul>
<li>前端将IP、cname、访问的url传输到后端</li>
</ul>
<h3 id="wnzz-visit表（直接存储访问记录）"><a href="#wnzz-visit表（直接存储访问记录）" class="headerlink" title="wnzz_visit表（直接存储访问记录）"></a>wnzz_visit表（直接存储访问记录）</h3><table>
<thead>
<tr>
<th>键名</th>
<th>说明</th>
<th>类型</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>自动编号</td>
<td>int11</td>
</tr>
<tr>
<td>ip</td>
<td>ip地址</td>
<td>varchar128</td>
</tr>
<tr>
<td>cname</td>
<td>地区</td>
<td>varchar255</td>
</tr>
<tr>
<td>url</td>
<td>访问地址</td>
<td>varchar255</td>
</tr>
<tr>
<td>time</td>
<td>访问时间戳</td>
<td>int11</td>
</tr>
<tr>
<td>siteid</td>
<td>统计站点编号</td>
<td>int11</td>
</tr>
</tbody></table>
<ul>
<li>字段 siteid，用来标记和区分不同的站点，这样可以实现多站点统计，只需要确保siteid不重复即可</li>
</ul>
<h3 id="wnzz-cal表（聚合一天的数据，存储计算结果）"><a href="#wnzz-cal表（聚合一天的数据，存储计算结果）" class="headerlink" title="wnzz_cal表（聚合一天的数据，存储计算结果）"></a>wnzz_cal表（聚合一天的数据，存储计算结果）</h3><ul>
<li>该表的作用是，当某一天已经过去时，自动计算某一天IP和PV总值，记录在这个表中</li>
</ul>
<blockquote>
<p>为什么需要这个表？因为当日统计的IP和PV都是动态计算的，php从数据库读出所有访问的数据，然后再对数据进行统计，如此方法加大了服务器的开销，所以对于一些不必要的重复计算，我们计算一次，存储其即可，下次需要直接读取。</p>
</blockquote>
<table>
<thead>
<tr>
<th>键名</th>
<th>说明</th>
<th>类型</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>自动编号</td>
<td>int11</td>
</tr>
<tr>
<td>timestamp</td>
<td>某一天0点的时间戳</td>
<td>int11</td>
</tr>
<tr>
<td>timestr</td>
<td>某一天用字符表示，例如2019-05-05</td>
<td>varchar255</td>
</tr>
<tr>
<td>ips</td>
<td>IP总数</td>
<td>int11</td>
</tr>
<tr>
<td>pvs</td>
<td>PV总数</td>
<td>int11</td>
</tr>
<tr>
<td>siteid</td>
<td>统计站点编号</td>
<td>int11</td>
</tr>
</tbody></table>
<h2 id="计算IP、PV"><a href="#计算IP、PV" class="headerlink" title="计算IP、PV"></a>计算IP、PV</h2><ul>
<li><p>首先需要确认 siteid 和统计事件的区间</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">php</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//设置北京时间为默认时区</span></span><br><span class="line">date_default_timezone_set(<span class="string">'PRC'</span>);</span><br><span class="line"><span class="comment">// 现在的时间戳</span></span><br><span class="line">$now = time();</span><br><span class="line"><span class="comment">// 现在对应今日0点的时间戳</span></span><br><span class="line">$today = strtotime(date(<span class="string">"Y-m-d"</span>), $now);</span><br><span class="line"><span class="comment">// 现在对应昨日0点的时间戳</span></span><br><span class="line">$yesterday = $today - <span class="number">86400</span>;</span><br><span class="line"><span class="comment">// 现在对应明日0点的时间戳</span></span><br><span class="line">$tomorrow = $today + <span class="number">86400</span>;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>动态统计一下今天的数据，即 <code>today&lt;=time&lt;tomorrow</code>，执行如下sql语句</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- 原生SQL写法</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`wnzz_visit`</span> <span class="keyword">WHERE</span> <span class="string">`time`</span>&gt;&#123;$today&#125; <span class="keyword">AND</span> <span class="string">`time`</span>&lt;&#123;$tomorrow&#125; <span class="keyword">AND</span> <span class="string">`siteid`</span>=&#123;$siteid&#125;;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>持久层框架写法(下面提供)</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">php</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$res_t = $bean-&gt;findByX([<span class="string">'ip'</span>], <span class="string">"wnzz_visit"</span>, [<span class="string">"time&gt;&#123;$today&#125;"</span>, <span class="string">"time&lt;&#123;$tomorrow&#125;"</span>, <span class="string">"siteid=&#123;$siteid&#125;"</span>]);</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>从数据库读出的数据形如如下:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">datas&#x3D;&gt;[</span><br><span class="line"></span><br><span class="line">    [&quot;ip&quot;&#x3D;&gt;&quot;127.0.0.1&quot;],</span><br><span class="line"></span><br><span class="line">    [&quot;ip&quot;&#x3D;&gt;&quot;127.0.0.1&quot;],</span><br><span class="line"></span><br><span class="line">    [&quot;ip&quot;&#x3D;&gt;&quot;127.0.0.1&quot;],</span><br><span class="line"></span><br><span class="line">    [&quot;ip&quot;&#x3D;&gt;&quot;127.0.0.2&quot;],</span><br><span class="line"></span><br><span class="line">    [&quot;ip&quot;&#x3D;&gt;&quot;127.0.0.2&quot;],</span><br><span class="line"></span><br><span class="line">    [&quot;ip&quot;&#x3D;&gt;&quot;127.0.0.2&quot;],</span><br><span class="line"></span><br><span class="line">    [&quot;ip&quot;&#x3D;&gt;&quot;127.0.0.3&quot;]</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure></div>

</li>
</ul>
<p><a href="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200310163423.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200310163423.png" class="lazyload"></a></p>
<ul>
<li>用PHP实现<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">php</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array(ips, pvs)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cal_ipandpv</span><span class="params">($datas)</span></span>&#123;</span><br><span class="line">    <span class="comment">// echo "emmm&lt;br/&gt;";</span></span><br><span class="line">    <span class="comment">// print_r($datas);</span></span><br><span class="line">    <span class="comment">// $ip['192.168.1.1'] = 10;</span></span><br><span class="line">    $ip = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span>($datas <span class="keyword">as</span> $index =&gt; $item)&#123;</span><br><span class="line">        <span class="keyword">if</span>(array_key_exists($item[<span class="string">'ip'</span>], $ip))&#123;</span><br><span class="line">            <span class="comment">// 统计过</span></span><br><span class="line">            $ip[$item[<span class="string">'ip'</span>]] += <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">// 没统计过</span></span><br><span class="line">            $ip[$item[<span class="string">'ip'</span>]] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 累加IP和PV</span></span><br><span class="line">    $ips = <span class="number">0</span>;</span><br><span class="line">    $pvs = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">foreach</span>($ip <span class="keyword">as</span> $keyip =&gt; $count)&#123;</span><br><span class="line">        $ips++;</span><br><span class="line">        $pvs += $count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [$ips, $pvs];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

</li>
</ul>
<h2 id="计算当前在线人数"><a href="#计算当前在线人数" class="headerlink" title="计算当前在线人数"></a>计算当前在线人数</h2><ul>
<li><p>访问记录在十分钟以内的即算作在线</p>
</li>
<li><p>SQL语句</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`wnzz_visit`</span> <span class="keyword">WHERE</span> <span class="string">`time`</span>&gt;&#123;$onlineMin &#125; <span class="keyword">AND</span> <span class="string">`siteid`</span>=&#123;$siteid&#125;;</span><br></pre></td></tr></table></figure></div>

</li>
</ul>
<h1 id="插件总体代码实现"><a href="#插件总体代码实现" class="headerlink" title="插件总体代码实现"></a>插件总体代码实现</h1><h2 id="前端（js）"><a href="#前端（js）" class="headerlink" title="前端（js）"></a>前端（js）</h2><ul>
<li><p>domain变量是后端接口地址，这里我开发用的本地IP</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Javascript</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://pv.sohu.com/cityjson?ie=utf-8</span></span><br><span class="line"><span class="keyword">var</span> domain = <span class="string">"http://127.0.0.1/vsCode/wnzz/"</span>;</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">window</span>.location.href;</span><br><span class="line"><span class="keyword">var</span> siteid = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">$.<span class="keyword">get</span>(domain + "?ip=" + returnCitySN["cip"] + "&amp;cname=" + returnCitySN["cname"] + "&amp;url=" + url + "&amp;siteid=" + siteid, function(result)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$.<span class="keyword">get</span>(domain + "?act=<span class="keyword">get</span>&amp;siteid=" + siteid, function(result)&#123;</span><br><span class="line">    $(<span class="string">"#wnzz"</span>).text(result);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>在引入上面的脚本之前要先引入jQuery库和下面的搜狐库</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">html</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://pv.sohu.com/cityjson?ie=utf-8"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>访问结果会显示在ID为wnzz的标签中</p>
</li>
</ul>
<h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><ul>
<li><p>后端使用PHP</p>
</li>
<li><p>在下面的代码之前需要引用<a href="/pan/BeanANDTools.zip">Bean.class.php、Tools.class.php</a>，下载之后直接引用。即可以下为wnzz服务端接口</p>
</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">php</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// ============================ //</span></span><br><span class="line"><span class="comment">//                              //</span></span><br><span class="line"><span class="comment">//        数据库参数配置         //</span></span><br><span class="line"><span class="comment">//                              //</span></span><br><span class="line"><span class="comment">// ============================ //</span></span><br><span class="line">define(<span class="string">"DB_HOST"</span>, <span class="string">"127.0.0.1"</span>);</span><br><span class="line"><span class="comment">// 数据库地址</span></span><br><span class="line">define(<span class="string">"DB_USER"</span>, <span class="string">"root"</span>);</span><br><span class="line"><span class="comment">// 数据库用户名</span></span><br><span class="line">define(<span class="string">"DB_PASSWD"</span>, <span class="string">"root"</span>);</span><br><span class="line"><span class="comment">// 数据库密码</span></span><br><span class="line">define(<span class="string">"DB_NAME"</span>, <span class="string">"wnzz"</span>);</span><br><span class="line"><span class="comment">// 数据库名</span></span><br><span class="line"><span class="comment">//设置北京时间为默认时区</span></span><br><span class="line">date_default_timezone_set(<span class="string">'PRC'</span>);</span><br><span class="line"><span class="comment">//输出当前时间</span></span><br><span class="line"><span class="comment">// echo date("Y-m-d H:i:s",time());  //2016-08-11 10:30:32</span></span><br><span class="line"><span class="comment">//获得当日凌晨的时间戳</span></span><br><span class="line"><span class="comment">// $today = strtotime(date("Y-m-d"),time());</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"./Tools.class.php"</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"./Bean.class.php"</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ip</span></span><br><span class="line"><span class="comment"> * cname</span></span><br><span class="line"><span class="comment"> * url</span></span><br><span class="line"><span class="comment"> * siteid</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">siteid </span></span><br><span class="line"><span class="comment">1000-1999 我的字段</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// 存储访客数据</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'ip'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'cname'</span>]) &amp;&amp; $_GET[<span class="string">'url'</span>] &amp;&amp; $_GET[<span class="string">'siteid'</span>]) &#123;</span><br><span class="line">	$ip = anti_sqlin($_GET[<span class="string">'ip'</span>]);</span><br><span class="line">	$cname = anti_sqlin($_GET[<span class="string">'cname'</span>]);</span><br><span class="line">	$url = anti_sqlin($_GET[<span class="string">'url'</span>]);</span><br><span class="line">	$siteid = (int)$_GET[<span class="string">'siteid'</span>];</span><br><span class="line">	$bean = <span class="keyword">new</span> Bean();</span><br><span class="line">	<span class="comment">// 现在的时间戳</span></span><br><span class="line">	$now = time();</span><br><span class="line">	<span class="comment">// 存储</span></span><br><span class="line">	$bean-&gt;save(<span class="string">"wnzz_visit"</span>, [<span class="string">"ip=&#123;$ip&#125;"</span>, <span class="string">"cname=&#123;$cname&#125;"</span>, <span class="string">"url=&#123;$url&#125;"</span>, <span class="string">"time=&#123;$now&#125;"</span>, <span class="string">"siteid=&#123;$siteid&#125;"</span>]);</span><br><span class="line">	<span class="comment">// 获取访问记录</span></span><br><span class="line">&#125; <span class="keyword">elseif</span>(<span class="keyword">isset</span>($_GET[<span class="string">'act'</span>]) &amp;&amp; $_GET[<span class="string">'act'</span>] == <span class="string">'get'</span> &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'siteid'</span>])) &#123;</span><br><span class="line">	$siteid = (int)$_GET[<span class="string">'siteid'</span>];</span><br><span class="line">	<span class="comment">// init</span></span><br><span class="line">	$y_ips = <span class="number">0</span>;</span><br><span class="line">	$y_pvs = <span class="number">0</span>;</span><br><span class="line">	$t_ips = <span class="number">0</span>;</span><br><span class="line">	$t_pvs = <span class="number">0</span>;</span><br><span class="line">	$online = <span class="number">0</span>;</span><br><span class="line">	$bean = <span class="keyword">new</span> Bean();</span><br><span class="line">	<span class="comment">// 现在的时间戳</span></span><br><span class="line">	$now = time();</span><br><span class="line">	<span class="comment">// 现在对应今日0点的时间戳</span></span><br><span class="line">	$today = strtotime(date(<span class="string">"Y-m-d"</span>), $now);</span><br><span class="line">	<span class="comment">// 现在对应昨日0点的时间戳</span></span><br><span class="line">	$yesterday = $today - <span class="number">86400</span>;</span><br><span class="line">	<span class="comment">// 现在对应明日0点的时间戳</span></span><br><span class="line">	$tomorrow = $today + <span class="number">86400</span>;</span><br><span class="line">	<span class="comment">// 查找昨天的记录</span></span><br><span class="line">	$res = $bean-&gt;findByX([<span class="string">'timestr'</span>, <span class="string">'ips'</span>, <span class="string">'pvs'</span>], <span class="string">"wnzz_cal"</span>, [<span class="string">"timestamp=&#123;$yesterday&#125;"</span>, <span class="string">"siteid=&#123;$siteid&#125;"</span>]);</span><br><span class="line">	<span class="keyword">if</span>($res[<span class="string">'status'</span>] == <span class="string">'data'</span>) &#123;</span><br><span class="line">		<span class="comment">// 有数据直接读</span></span><br><span class="line">		$y_ips = $res[<span class="string">'data'</span>][<span class="number">0</span>][<span class="string">'ips'</span>];</span><br><span class="line">		$y_pvs = $res[<span class="string">'data'</span>][<span class="number">0</span>][<span class="string">'pvs'</span>];</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// 计算并存储</span></span><br><span class="line">		$res_m = $bean-&gt;findByX([<span class="string">'ip'</span>], <span class="string">"wnzz_visit"</span>, [<span class="string">"time&gt;=&#123;$yesterday&#125;"</span>, <span class="string">"time&lt;&#123;$today&#125;"</span>, <span class="string">"siteid=&#123;$siteid&#125;"</span>]);</span><br><span class="line">		$datas = $res_m[<span class="string">'data'</span>];</span><br><span class="line">		$ipsandpvs = cal_ipandpv($datas);</span><br><span class="line">		<span class="comment">// 存储</span></span><br><span class="line">		<span class="comment">// $ips</span></span><br><span class="line">		<span class="comment">// $pvs</span></span><br><span class="line">		<span class="comment">// $yesterday</span></span><br><span class="line">		<span class="comment">// $yesterday_timestamp</span></span><br><span class="line">		$ips = $ipsandpvs[<span class="number">0</span>];</span><br><span class="line">		$pvs = $ipsandpvs[<span class="number">1</span>];</span><br><span class="line">		$yesterday_timestamp = date(<span class="string">"Y-m-d"</span>, $yesterday);</span><br><span class="line">		$y_ips = $ips;</span><br><span class="line">		$y_pvs = $pvs;</span><br><span class="line">		$res1 = $bean-&gt;save(<span class="string">"wnzz_cal"</span>, [<span class="string">"ips=&#123;$ips&#125;"</span>, <span class="string">"pvs=&#123;$pvs&#125;"</span>, <span class="string">"timestamp=&#123;$yesterday&#125;"</span>, <span class="string">"timestr=&#123;$yesterday_timestamp&#125;"</span>, <span class="string">"siteid=&#123;$siteid&#125;"</span>]);</span><br><span class="line">		<span class="comment">// print_r($res1);</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 查找今天的记录</span></span><br><span class="line">	$res_t = $bean-&gt;findByX([<span class="string">'ip'</span>], <span class="string">"wnzz_visit"</span>, [<span class="string">"time&gt;&#123;$today&#125;"</span>, <span class="string">"time&lt;&#123;$tomorrow&#125;"</span>, <span class="string">"siteid=&#123;$siteid&#125;"</span>]);</span><br><span class="line">	$datas_t = $res_t[<span class="string">'data'</span>];</span><br><span class="line">	$ipsandpvs_t = cal_ipandpv($datas_t);</span><br><span class="line">	$ips_t = $ipsandpvs_t[<span class="number">0</span>];</span><br><span class="line">	$pvs_t = $ipsandpvs_t[<span class="number">1</span>];</span><br><span class="line">	$t_ips = $ips_t;</span><br><span class="line">	$t_pvs = $pvs_t;</span><br><span class="line">	<span class="comment">// 获取当前在线，10min内为在线</span></span><br><span class="line">	<span class="comment">// 用PV计算当前在线数</span></span><br><span class="line">	$onlineMin = $now - <span class="number">600</span>;</span><br><span class="line">	$res_o = $bean-&gt;findByX([<span class="string">'ip'</span>], <span class="string">"wnzz_visit"</span>, [<span class="string">"time&gt;&#123;$onlineMin&#125;"</span>, <span class="string">"siteid=&#123;$siteid&#125;"</span>]);</span><br><span class="line">	$datas_o = $res_o[<span class="string">'data'</span>];</span><br><span class="line">	$ipsandpvs_o = cal_ipandpv($datas_o);</span><br><span class="line">	$ips_o = $ipsandpvs_o[<span class="number">0</span>];</span><br><span class="line">	$pvs_o = $ipsandpvs_o[<span class="number">1</span>];</span><br><span class="line">	<span class="comment">// $t_ips = $ips_o;</span></span><br><span class="line">	$online = $pvs_o;</span><br><span class="line">	<span class="comment">// $y_ips = 0;</span></span><br><span class="line">	<span class="comment">// $y_pvs = 0;</span></span><br><span class="line">	<span class="comment">// $t_ips = 0;</span></span><br><span class="line">	<span class="comment">// $t_pvs = 0;</span></span><br><span class="line">	<span class="comment">// $online = 0;</span></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"webpro统计|今日IP[&#123;$t_ips&#125;]|今日PV[&#123;$t_pvs&#125;]|昨日IP[&#123;$y_ips&#125;]|昨日PV[&#123;$y_pvs&#125;]|当前在线[&#123;$online&#125;]"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array(ips, pvs)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cal_ipandpv</span><span class="params">($datas)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// echo "emmm&lt;br/&gt;";</span></span><br><span class="line">	<span class="comment">// print_r($datas);</span></span><br><span class="line">	<span class="comment">// $ip['192.168.1.1'] = 10;</span></span><br><span class="line">	$ip = <span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">foreach</span>($datas <span class="keyword">as</span> $index =&gt; $item) &#123;</span><br><span class="line">		<span class="keyword">if</span>(array_key_exists($item[<span class="string">'ip'</span>], $ip)) &#123;</span><br><span class="line">			<span class="comment">// 统计过</span></span><br><span class="line">			$ip[$item[<span class="string">'ip'</span>]] += <span class="number">1</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 没统计过</span></span><br><span class="line">			$ip[$item[<span class="string">'ip'</span>]] = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 累加IP和PV</span></span><br><span class="line">	$ips = <span class="number">0</span>;</span><br><span class="line">	$pvs = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">foreach</span>($ip <span class="keyword">as</span> $keyip =&gt; $count) &#123;</span><br><span class="line">		$ips++;</span><br><span class="line">		$pvs += $count;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> [$ips, $pvs];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">anti_sqlin</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">	$data = str_replace(<span class="string">"'"</span>, <span class="string">""</span>, $data);</span><br><span class="line">	<span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="在要统计的页面中安装"><a href="#在要统计的页面中安装" class="headerlink" title="在要统计的页面中安装"></a>在要统计的页面中安装</h1><h2 id="在合适位置添加统计代码"><a href="#在合适位置添加统计代码" class="headerlink" title="在合适位置添加统计代码"></a>在合适位置添加统计代码</h2><ul>
<li>在head代码处添加、或者有的网站后台管理中留有网站统计填写等合适位置，添加如下代码(xxx/xxx.js改成自己的服务器上的JS地址)</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">html</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://pv.sohu.com/cityjson?ie=utf-8"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://xxx/xxx.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p><a href="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200310164440.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200310164440.png" class="lazyload"></a></p>
<ul>
<li>然后在你需要显示统计数据的地方添加如下div标签</li>
</ul>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">html</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"wnzz"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="插件测试"><a href="#插件测试" class="headerlink" title="插件测试"></a>插件测试</h2><ul>
<li>安装好后，刷新网站进行测试</li>
</ul>
<p><a href="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200310162203.png" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200310162203.png" class="lazyload"></a></p>
<blockquote>
<p>安装成功！</p>
</blockquote>
<ul>
<li>如果要实现多网站统计，设置不同的siteid，避免siteid重复即可！</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Bill</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://blog.webpro.ltd/2019/05/29/get-my-site-pageview/">http://blog.webpro.ltd/2019/05/29/get-my-site-pageview/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://blog.webpro.ltd">Bill's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/php/">php    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200312095556.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/08/09/Linux-c-review1/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200312101338.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200308222851.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Linux c 程序设计考试 复习</span></div></a></div><div class="next-post pull_right"><a href="/2019/05/26/OrangePi-Zero-run-springboot/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200309195907.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200308222851.jpg'"><div class="label">下一篇</div><div class="next_info"><span>OrangePi Zero嵌入式板搭建微服务网关[Ubuntu_Server1504+JDK1.8]</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2018/01/24/php-shoping/" title="基于PHP+MySQL的小型网上商城系统"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200311110917.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-01-24</div><div class="relatedPosts_title">基于PHP+MySQL的小型网上商城系统</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var createIssueManually = false == true ? true : false;
var distractionFreeMode = false == true ? true : false;
var gitalk = new Gitalk({
  clientID: '7db6d80f4f95761969f5',
  clientSecret: '3e0e2ca6e22e762d50dfd210a50cd5e0a3e473ae',
  repo: 'billwhite246.github.io',
  owner: 'billwhite246',
  admin: 'billwhite246',
  id: md5(decodeURI(location.pathname)),
  createIssueManually: createIssueManually,
  distractionFreeMode: distractionFreeMode,
  language: 'zh-CN',
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
}</script></div></div></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/billwhite246/myPicBedRepo@master/img/20200312095556.png)" data-type="photo"><div id="footer-wrap"><div class="copyright">Copyright&copy;2017 - 2020 By Bill</div><div class="framework-info"><span id="who_powered"></span></div><div id="wnzz"></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>